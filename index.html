<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ü—Ä–æ—Ä–æ–∫ (–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–π)</title>
    <!-- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω –∫—Ä–∞—Å–∏–≤—ã–π SVG-—Ñ–∞–≤–∏–∫–æ–Ω –≤ –≤–∏–¥–µ –º–∞–≥–∏—á–µ—Å–∫–æ–π –∑–≤–µ–∑–¥—ã -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath d='M16 0L19.5359 12.4641L32 16L19.5359 19.5359L16 32L12.4641 19.5359L0 16L12.4641 12.4641L16 0Z' fill='%234a2c2a'/%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/flatpickr.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
    
    <!-- 
      –ò–ú–ü–û–†–¢ –ò –ù–ê–°–¢–†–û–ô–ö–ê FIREBASE
      (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    -->
    <script type="module">
        // --- –¢–í–û–ô –ö–û–ù–§–ò–ì FIREBASE (–≤—Å—Ç—Ä–æ–µ–Ω –Ω–∞–ø—Ä—è–º—É—é) ---
        // –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∫–æ–Ω—Ñ–∏–≥ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
        const firebaseConfig = {
          apiKey: "AIzaSyDYGKiBAEtfp3DKAX4PDR2OymJ3YJlfMXg",
          authDomain: "magic-diary-1a1cf.firebaseapp.com",
          projectId: "magic-diary-1a1cf",
          storageBucket: "magic-diary-1a1cf.firebasestorage.app",
          messagingSenderId: "362532075783",
          appId: "1:362532075783:web:d5e0ce019c031852afada2"
        };
        // ----------------------------------------------------
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'appId' –∏–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è –ø—É—Ç–µ–π –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        const appId = firebaseConfig.appId;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        try {
            const { initializeApp, setLogLevel } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { 
                getAuth, 
                signInAnonymously, 
                signInWithCustomToken, 
                onAuthStateChanged,
                createUserWithEmailAndPassword, 
                signInWithEmailAndPassword,     
                signOut                         
            } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            
            const { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, Timestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            const { getDatabase, ref, set, onValue, onDisconnect } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js");

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const rtdb = getDatabase(app);
            
            setLogLevel('debug');

            window.firebaseServices = {
                auth, db, rtdb, appId,
                signInAnonymously, onAuthStateChanged,
                createUserWithEmailAndPassword, 
                signInWithEmailAndPassword,     
                signOut,                        
                doc, getDoc, setDoc, 
                addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, Timestamp, 
                ref, set, onValue, onDisconnect
            };
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", e);
            document.body.innerHTML = '<div class="text-white p-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ `firebaseConfig`.</div>';
        }
    </script>
    
    <style>
        :root {
            --cat-students: #3b82f6; --cat-home: #d97706; --cat-projects: #9333ea;
            --cat-hobbies: #10b981; --cat-love: #ec4899; --cat-shop: #eab308; --cat-docs: #64748b;
        }
        body {
            font-family: 'Merriweather', serif; background-color: #1a1a2e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-denim.png');
            overflow-x: hidden;
        }
        .magic-parchment {
            background-color: rgba(250, 245, 230, 0.95); border: 4px solid #4a2c2a;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 15px rgba(74, 44, 42, 0.5) inset;
        }
        h1.magic-title { 
            font-family: 'Uncial Antiqua', 'Cinzel Decorative', serif; 
            text-shadow: 1px 1px 2px rgba(199, 162, 101, 0.7); 
        }

        /* --- –°–¢–ò–õ–ò –¢–ê–ô–ú–ï–†–ê --- */
        #stickyTimer { position: fixed; top: 1rem; right: 1rem; z-index: 1000; width: 220px; transition: transform 0.3s ease; }
        .timer-display-compact { font-family: 'Cinzel Decorative', serif; font-size: 1.8rem; font-weight: 700; color: #4a2c2a; text-align: center; line-height: 1; cursor: pointer; }
        .btn-timer-small { font-size: 0.8rem; padding: 4px 8px; background-color: #4a2c2a; color: #fdf5e6; border: 1px solid #c7a265; border-radius: 4px; cursor: pointer; }
        .btn-timer-small:hover { background-color: #6d413c; }
        .btn-icon-small { background: none; border: none; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; font-size: 1.1rem; }
        .btn-icon-small:hover, .btn-icon-small.active { opacity: 1; }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï iOS: –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∏–Ω–ø—É—Ç —Ç–∞–π–º–µ—Ä–∞ –∏–º–µ–µ—Ç —Ü–≤–µ—Ç */
        #timerInput {
            color: #4a2c2a;
            background-color: #fff;
        }

        /* --- –ö–ê–¢–ï–ì–û–†–ò–ò --- */
        .category-pill { display: inline-block; cursor: pointer; font-size: 0.85rem; font-weight: bold; padding: 0.25rem 0.75rem; border-radius: 9999px; color: white; border: 2px solid transparent; transition: all 0.2s; opacity: 0.7; }
        .category-pill:hover { opacity: 1; transform: translateY(-1px); }
        .category-pill input { display: none; }
        .category-pill:has(input:checked) { opacity: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border-color: #4a2c2a; transform: scale(1.05); }
        .cat-students { background-color: var(--cat-students); } .cat-home { background-color: var(--cat-home); }
        .cat-projects { background-color: var(--cat-projects); } .cat-hobbies { background-color: var(--cat-hobbies); }
        .cat-love { background-color: var(--cat-love); } .cat-shop { background-color: var(--cat-shop); }
        .cat-docs { background-color: var(--cat-docs); }
        .task-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; margin-right: 0.5rem; display: inline-block; vertical-align: middle; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–≥–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è */
        .assignee-tag {
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;
            color: #4a2c2a; background-color: #fef08a; border: 1px solid #c7a265;
            font-weight: bold; margin-left: 0.5rem; display: inline-block;
            vertical-align: middle;
        }

        /* --- –ö–ê–õ–ï–ù–î–ê–†–¨ --- */
        #calendarViewContainer { display: none; min-height: 500px; }
        .fc { font-family: 'Merriweather', serif; color: #4a2c2a; }
        .fc-toolbar-title { font-family: 'Cinzel Decorative', serif !important; }
        .fc-button-primary { background-color: #4a2c2a !important; border-color: #c7a265 !important; font-family: 'Merriweather', serif; font-weight: bold; }
        .fc-day-today { 
            background-color: rgba(199, 162, 101, 0.2) !important; 
            box-shadow: inset 0 0 0 2px #c7a265 !important; 
        }
        .fc-daygrid-month-view .fc-daygrid-event { display: none; }
        .fc-daygrid-day-frame { cursor: pointer; position: relative; } 
        .fc-daygrid-day-frame:hover { background-color: rgba(199, 162, 101, 0.1); }
        .fc-daygrid-day-number { position: relative; z-index: 1; padding-left: 5px; padding-top: 2px; }
        .day-task-count {
            position: absolute; bottom: 4px; right: 4px; z-index: 0; font-size: 0.9rem;
            font-weight: bold; padding: 2px 6px; border-radius: 4px;
            background-color: rgba(74, 44, 42, 0.7); color: white; line-height: 1.2;
        }
        .day-task-count-completed { background-color: rgba(22, 163, 74, 0.8); }
        .day-task-count-mixed { background-color: rgba(217, 119, 6, 0.8); }

        /* --- –û–ë–©–ò–ï –≠–õ–ï–ú–ï–ù–¢–´ --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { 
            width: 100%; max-width: 42rem; max-height: 90vh; overflow-y: auto; 
            scrollbar-width: thin; scrollbar-color: #4a2c2a rgba(250, 245, 230, 0.95);
        }
        .btn-magic { font-family: 'Merriweather', serif; font-weight: 700; background-color: #4a2c2a; color: #fdf5e6; border: 2px solid #c7a265; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.2s ease; cursor: pointer; }
        .btn-magic:hover { background-color: #6d413c; color: #fff; transform: translateY(-2px); }
        .btn-magic:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; border-color: #6b7280; }
        
        .magic-input {
            width: 100%; padding: 0.75rem; border-radius: 6px; border: 2px solid #c7a265;
            background-color: #fff; color: #4a2c2a;
            font-family: 'Merriweather', serif; font-size: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) inset; transition: all 0.2s;
        }
        .magic-input:focus {
            outline: none; border-color: #4a2c2a; background-color: #fff;
            box-shadow: 0 0 10px rgba(199, 162, 101, 0.5);
        }
        .magic-label {
            display: block; text-sm font-bold text-yellow-900 mb-2;
        }

        /* --- –°–¢–ò–õ–ò –ó–ê–î–ê–ß --- */
        .task-item { animation: fadeIn 0.4s ease-out; border-left-width: 8px; transition: all 0.3s ease; }
        .task-item.status-completed { opacity: 0.6; filter: grayscale(50%); text-decoration: line-through; }
        .task-item.status-inProgress { background-color: #fffbeb !important; border-left-color: var(--cat-projects); }
        .task-item.priority-high { border-left-color: #e53e3e; }
        .task-item.priority-medium { border-left-color: #f6e05e; }
        .task-item.priority-low { border-left-color: #a0aec0; }
        
        .task-spell-btn {
            font-size: 1rem; /* 16px */
            width: 2rem;     /* 32px */
            height: 2rem;    /* 32px */
            padding: 0;
            border-radius: 9999px; /* Circle */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s;
            font-family: monospace; font-weight: bold; border: 1px solid;
            color: white;
        }
        .task-spell-btn svg {
            width: 1em; 
            height: 1em;
        }
        .task-spell-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –í–ò–î–û–í (–§–∏–ª—å—Ç—Ä—ã) --- */
        .view-toggle { display: flex; background: rgba(255,255,255,0.3); border-radius: 8px; p-1; margin-bottom: 1rem; border: 1px solid #c7a265; }
        .view-btn { flex: 1; text-align: center; padding: 0.5rem; cursor: pointer; font-weight: bold; color: #6d413c; transition: all 0.2s; border-radius: 6px; }
        .view-btn.active { background-color: #4a2c2a; color: #fdf5e6; }

        /* --- –°–¢–ò–õ–ò (–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ) --- */
        .presence-indicator { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: background-color 0.3s; }
        .presence-online { background-color: #22c55e; }
        .presence-offline { background-color: #9ca3af; } /* –ò–ó–ú–ï–ù–ï–ù–û: –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å–µ—Ä—ã–π */

        /* --- –°–¢–ò–õ–ò (–≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞) --- */
        #authOverlay {
            position: fixed; inset: 0; z-index: 3000;
            display: flex; align-items: center; justify-content: center;
            background-color: #1a1a2e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-denim.png');
            transition: opacity 0.3s ease;
        }
        .auth-tabs { display: flex; border-bottom: 2px solid #4a2c2a; margin-bottom: 1.5rem; }
        .auth-tab {
            flex: 1; text-align: center; padding: 0.75rem 1rem;
            font-family: 'Cinzel Decorative', serif; font-weight: 700;
            color: #6d413c; cursor: pointer;
            border-bottom: 3px solid transparent; transform: translateY(2px);
            transition: all 0.2s;
        }
        .auth-tab.active { color: #4a2c2a; border-bottom-color: #c7a265; }
        
        /* --- –°–¢–ò–õ–ò (–ü–æ–¥–∑–∞–¥–∞—á–∏) --- */
        .subtask-item { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .subtask-item input[type="checkbox"] { 
            width: 1.25rem; height: 1.25rem; flex-shrink: 0; 
            border-radius: 4px; border: 2px solid #c7a265; cursor: pointer;
        }
        .subtask-text { flex-grow: 1; padding: 0.5rem; font-size: 0.9rem; border-radius: 4px; border: 1px solid #c7a265; background: #fff; transition: all 0.2s; }
        .subtask-item input[type="checkbox"]:checked + .subtask-text,
        .subtask-item input[type="checkbox"]:checked + label.subtask-text {
            text-decoration: line-through; opacity: 0.7; 
        }
        .subtask-delete-btn {
            background-color: #ef4444; color: white; border: none;
            width: 1.5rem; height: 1.5rem; border-radius: 9999px;
            font-weight: bold; cursor: pointer; opacity: 0.7;
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
        }
        .subtask-delete-btn:hover { opacity: 1; }
        .hidden { display: none; }

        /* --- –°–¢–ò–õ–ò (–°—Ç–∏–∫–µ—Ä—ã / –ö—É–±–∞—Ä–∏–∫–∏) --- */
        #stickerBackdrop {
            position: fixed; inset: 0; width: 100vw; height: 100vh;
            z-index: 4000; pointer-events: none;
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8) rotate(-10deg); }
            to { opacity: 1; transform: scale(1); }
        }
        .sticker-note-absolute {
            position: absolute; width: 200px; height: 200px;
            padding: 1rem; padding-top: 2rem; color: #4a2c2a;
            font-family: 'Merriweather', serif; animation: popIn 0.4s ease-out;
            pointer-events: auto; cursor: grab;
            background-image: url('https://placehold.co/200x200/fef08a/fef08a.png');
            background-size: contain; background-repeat: no-repeat;
            filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.3));
            /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï iOS: –£–ª—É—á—à–∞–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
            will-change: transform;
        }
        .sticker-delete-btn {
            position: absolute; top: 4px; right: 4px;
            background-color: #ef4444; color: white;
            width: 1.25rem; height: 1.25rem; border-radius: 50%;
            border: none; cursor: pointer; opacity: 0.3; font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.2s;
        }
        .sticker-note-absolute:hover .sticker-delete-btn { opacity: 1; }
        .sticker-text {
            width: 100%; height: 100%; font-size: 0.9rem;
            overflow-y: auto; whitespace-pre-wrap;
            word-wrap: break-word; pointer-events: none;
        }
        .sticker-author {
            position: absolute; bottom: 8px; right: 12px;
            font-size: 0.7rem; font-weight: bold; opacity: 0.6;
            pointer-events: none;
        }

        /* --- –°–¢–ò–õ–ò (–ù–∞–≤–∏–≥–∞—Ü–∏—è) --- */
        .magic-nav {
            display: flex; background-color: rgba(74, 44, 42, 0.5);
            border-radius: 8px; border: 2px solid #c7a265;
            margin-bottom: 1.5rem; padding: 0.5rem; gap: 0.5rem;
        }
        .nav-btn {
            flex: 1; text-align: center; padding: 0.75rem 0.5rem;
            border-radius: 6px; cursor: pointer;
            font-family: 'Cinzel Decorative', serif; font-weight: 700;
            color: #fdf5e6; opacity: 0.7; transition: all 0.2s ease;
            font-size: 1.1rem;
        }
        .nav-btn:hover { opacity: 1; background-color: rgba(255, 255, 255, 0.1); }
        .nav-btn.active {
            opacity: 1; background-color: #4a2c2a;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); color: #fef08a;
        }
        .view-container {
            animation: fadeIn 0.3s ease-out;
            position: relative; z-index: 20; 
        }

        /* --- –°–¢–ò–õ–ò (–ö–Ω–æ–ø–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞) --- */
        .btn-header-icon {
            background-color: rgba(74, 44, 42, 0.7); /* 4a2c2a —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
            border: 2px solid #c7a265; /* –ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞ */
            color: #fdf5e6; /* –¶–≤–µ—Ç –∏–∫–æ–Ω–∫–∏ (–ø–µ—Ä–≥–∞–º–µ–Ω—Ç) */
            border-radius: 50%;
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem; /* –†–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ */
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn-header-icon:hover {
            background-color: #6d413c; /* –¢–µ–º–Ω–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
            color: #fff;
            transform: scale(1.1) rotate(5deg); /* –ú–∞–≥–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç */
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

    </style>
</head>
<body class="p-4">

    <!-- 
      –≠–ö–†–ê–ù –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò
      (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    -->
    <div id="authOverlay">
        <div class="magic-parchment p-6 md:p-8 w-full max-w-md mx-4">
            <h1 class="magic-title text-3xl font-bold text-yellow-900 text-center mb-6">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ü—Ä–æ—Ä–æ–∫</h1>
            
            <div class="auth-tabs">
                <div id="authTabLogin" class="auth-tab active">–í—Ö–æ–¥</div>
                <div id="authTabRegister" class="auth-tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>

            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" class="magic-input" placeholder="–í–æ–ª—à–µ–±–Ω—ã–π email..." required>
                <input type="password" id="loginPassword" class="magic-input" placeholder="–¢–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ (–ø–∞—Ä–æ–ª—å)..." required>
                <button id="loginBtn" type="submit" class="btn-magic w-full py-3 text-lg rounded-lg mt-2">–í–æ–π—Ç–∏ –≤ –ø–æ—Ä—Ç–∞–ª</button>
            </form>

            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <form id="registerForm" class="space-y-4" style="display: none;">
                <input type="text" id="registerNickname" class="magic-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º..." required>
                <input type="email" id="registerEmail" class="magic-input" placeholder="–í–∞—à –Ω–æ–≤—ã–π email..." required>
                <input type="password" id="registerPassword" class="magic-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å..." required>
                <input type="password" id="registerConfirmPassword" class="magic-input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å..." required>
                <button id="registerBtn" type="submit" class="btn-magic w-full py-3 text-lg rounded-lg mt-2">–°–æ–∑–¥–∞—Ç—å —Å–≤–∏—Ç–æ–∫</button>
            </form>

            <div id="authError" class="text-center text-red-600 font-bold mt-4 h-6"></div>
        </div>
    </div>


    <!-- 
      –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –°–¢–ò–ö–ï–†–û–í
      (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    -->
    <div id="stickerBackdrop"></div>
    
    <!-- 
      –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
    -->
    <div id="mainAppContainer" class="max-w-4xl mx-auto mt-8 md:mt-0 px-4 relative z-40" style="display: none;">

        <!-- 
            –¢–∞–π–º–µ—Ä "–ó–µ–ª—å–µ –§–æ–∫—É—Å–∞"
        -->
        <div id="stickyTimer" class="magic-parchment p-3 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-yellow-900 uppercase tracking-widest">–ó–µ–ª—å–µ –§–æ–∫—É—Å–∞</span>
                <div class="flex gap-2">
                    <button id="timerSettingsBtn" class="btn-icon-small" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä–µ–º—è">‚öôÔ∏è</button>
                    <button id="noiseToggleBtn" class="btn-icon-small" title="–®—É–º –í—ã—Ä—É—á–∞–π-–∫–æ–º–Ω–∞—Ç—ã">üéß</button>
                </div>
            </div>
            <div id="timerDisplayContainer" class="relative">
                <div id="timerDisplay" class="timer-display-compact">25:00</div>
                <!-- 
                  –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï iOS: 
                  type="number" –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ type="text" –∏ inputmode="numeric" 
                  –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–≥–∞ —Å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º —Ç–µ–∫—Å—Ç–∞.
                -->
                <input type="text" inputmode="numeric" pattern="[0-9]*" id="timerInput" class="magic-input absolute inset-0 w-full text-center text-2xl hidden" value="25">
            </div>
            <div id="timerStatus" class="text-center text-xs text-gray-600 h-4 truncate mb-2">–ö–æ—Ç–µ–ª–æ–∫ –æ—Å—Ç—ã–ª</div>
            <div class="flex gap-2 justify-center">
                <button id="startTimerBtn" class="btn-timer-small flex-grow">–í–∞—Ä–∏—Ç—å!</button>
                <button id="resetTimerBtn" class="btn-timer-small" title="–°–±—Ä–æ—Å–∏—Ç—å">‚Üª</button>
            </div>
        </div>
        
        <header class="text-center mb-6 relative pt-4">
            <h1 class="magic-title text-4xl md:text-5xl font-bold text-yellow-100">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ü—Ä–æ—Ä–æ–∫</h1>
            
            <div id="userControls" class="absolute top-0 right-0 p-2 flex gap-2">
                 <button id="hatSortBtn" class="btn-header-icon" title="–°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–∞—á–∞">üé©</button>
                 <button id="openSettingsBtn" class="btn-header-icon" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
                 <button id="logoutBtn" class="btn-header-icon" title="–í—ã–π—Ç–∏">üö™</button>
            </div>
        </header>

        <!-- 
            –ì–õ–ê–í–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø 
            (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        -->
        <nav class="magic-nav">
            <button id="nav-tasks" class="nav-btn active">üìú –ó–∞–¥–∞—á–∏</button>
            <button id="nav-calendar" class="nav-btn">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
            <button id="openStickerModalBtn" class="nav-btn">üìå –ù–æ–≤–∞—è –ü–æ–º–µ—Ç–∫–∞</button>
        </nav>

        <!-- 
          –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã-–í—å—é—à–∫–∏
        -->

        <!-- –í–¨–Æ–®–ö–ê: –ó–∞–¥–∞—á–∏ -->
        <div id="tasksView" class="view-container">
            <div class="flex justify-center mb-6">
                <button id="openTaskModalBtn" class="btn-magic py-3 px-8 rounded-lg text-lg shadow-lg transform hover:scale-105 transition-transform">
                    –°–æ—Ç–≤–æ—Ä–∏—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ
                </button>
            </div>
            
            <main class="magic-parchment p-4 md:p-6">
                 <!-- 
                    –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ú–æ–¥—É–ª—å –ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è 
                    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ HTML –∏–∑–º–µ–Ω–µ–Ω–∞, —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                 -->
                 <div id="presenceContainer" class="mb-4 p-3 bg-yellow-50 bg-opacity-50 rounded-lg border border-yellow-800 border-opacity-30">
                    <div class="flex flex-wrap justify-around items-center gap-4">
                        <!-- –°–ª–æ—Ç –¥–ª—è Yura Marev (–∏–º—è –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω–æ JS, –µ—Å–ª–∏ –æ–Ω –Ω–µ —Ç–µ–∫—É—â–∏–π —é–∑–µ—Ä) -->
                        <div id="currentUserStatus" class="text-center">
                            <span id="currentUserDisplay" class="font-bold text-gray-800 text-sm truncate">...</span>
                            <div class="flex items-center justify-center gap-2 mt-1">
                                <div id="currentUserIndicator" class="presence-indicator presence-offline"></div>
                            </div>
                        </div>
                        <!-- –°–ª–æ—Ç –¥–ª—è KoshkaKartoshka (–∏–º—è –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω–æ JS) -->
                        <div id="otherUserStatus" class="text-center">
                            <span id="otherUserName" class="font-bold text-gray-800 text-sm truncate">–û—Ñ—Ñ–ª–∞–π–Ω</span>
                            <div class="flex items-center justify-center gap-2 mt-1">
                                <div id="otherUserIndicator" class="presence-indicator presence-offline"></div>
                            </div>
                        </div>
                    </div>
                 </div>
                 
                 <!-- –§–∏–ª—å—Ç—Ä—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
                 <div class="view-toggle">
                    <button id="filterActive" class="view-btn active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                    <button id="filterHigh" class="view-btn">–°—Ä–æ—á–Ω—ã–µ</button>
                    <button id="filterCompleted" class="view-btn">–ê—Ä—Ö–∏–≤</button>
                 </div>

                 <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
                 <div id="taskListContainer" class="mt-4">
                    <div id="taskList" class="space-y-3 min-h-[100px]">
                        <p class="text-center text-gray-500 italic">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π...</p>
                    </div>
                 </div>
                 
            </main>
        </div>

        <!-- –í–¨–Æ–®–ö–ê: –ö–∞–ª–µ–Ω–¥–∞—Ä—å (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
        <div id="calendarView" class="view-container hidden">
            <div class="magic-parchment p-4 md:p-6">
                <div id='calendar'></div> 
            </div>
        </div>

    </div> <!-- –ö–æ–Ω–µ—Ü #mainAppContainer -->


    <!-- 
        –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
        (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    -->
    <div id="addTaskModal" class="modal-overlay">
        <div class="magic-parchment modal-content p-6 relative">
            <button id="closeTaskModalBtn" class="absolute top-2 right-2 text-2xl text-yellow-900 hover:text-yellow-600">&times;</button>
            <h3 class="text-2xl font-bold text-yellow-900 text-center magic-title mb-4">–ù–æ–≤–æ–µ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ</h3>
            
            <div class="space-y-4">
                <input type="text" id="taskInput" class="magic-input w-full text-lg" placeholder="–¢–µ–∫—Å—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è...">
                <textarea id="taskDescriptionInput" class="magic-input w-full" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏... (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>

                <div>
                    <label class="magic-label">–ú–∞–≥–∏—á–µ—Å–∫–∞—è –º–µ—Ç–∫–∞:</label>
                    <div class="flex flex-wrap gap-2">
                        <label class="category-pill cat-students"><input type="radio" name="taskCat" value="students" checked> –°—Ç—É–¥–µ–Ω—Ç—ã</label>
                        <label class="category-pill cat-home"><input type="radio" name="taskCat" value="home"> –î–æ–º</label>
                        <label class="category-pill cat-projects"><input type="radio" name="taskCat" value="projects"> –ü—Ä–æ–µ–∫—Ç—ã</label>
                        <label class="category-pill cat-hobbies"><input type="radio" name="taskCat" value="hobbies"> –•–æ–±–±–∏</label>
                        <label class="category-pill cat-love"><input type="radio" name="taskCat" value="love"> –õ—é–±–æ–≤—å</label>
                        <label class="category-pill cat-shop"><input type="radio" name="taskCat" value="shop"> –ú–∞–≥–∞–∑–∏–Ω</label>
                        <label class="category-pill cat-docs"><input type="radio" name="taskCat" value="docs"> –î–æ–∫—É–º–µ–Ω—Ç—ã</label>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input id="taskDueDate" class="magic-input" placeholder="–°—Ä–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è...">
                    
                    <select id="taskPriority" class="magic-input">
                        <option value="low">–û–±—ã—á–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                        <option value="medium" selected>–í–∞–∂–Ω—ã–π (Expelliarmus)</option>
                        <option value="high">–°—Ä–æ—á–Ω—ã–π! (–ù–µ–ø—Ä–µ–ª–æ–∂–Ω—ã–π)</option>
                    </select>
                </div>

                <div>
                    <label for="taskAssignee" class="magic-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</label>
                    <select id="taskAssignee" class="magic-input">
                        <option value="everyone">–î–ª—è –≤—Å–µ—Ö</option>
                        <option value="me">–¢–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω—è</option>
                        <option value="partner" disabled>–¢–æ–ª—å–∫–æ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞</option>
                    </select>
                </div>
                
                <div>
                    <label class="magic-label">–ü–æ–¥–∑–∞–¥–∞—á–∏:</label>
                    <div id="newTaskSubtaskList" class="space-y-2 p-3 bg-white bg-opacity-60 rounded-lg max-h-40 overflow-y-auto">
                        <p class="text-center text-sm text-gray-600 italic">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç...</p>
                    </div>
                    <div id="newTaskAddSubtaskContainer" class="flex gap-2 mt-2">
                        <input type="text" id="newTaskNewSubtask" class="magic-input flex-grow" placeholder="–ù–æ–≤—ã–π –ø—É–Ω–∫—Ç...">
                        <button id="newTaskAddSubtaskBtn" class="btn-magic px-4 rounded-lg">+</button>
                    </div>
                </div>

                <button id="addTaskBtn" class="btn-magic w-full py-3 text-lg rounded-lg mt-2">‚ö° –ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏! ‚ö°</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –°—Ç–∏–∫–µ—Ä–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
    <div id="stickerModal" class="modal-overlay">
        <div class="magic-parchment modal-content p-6 relative max-w-md">
            <button id="closeStickerModalBtn" class="absolute top-2 right-2 text-2xl text-yellow-900 hover:text-yellow-600">&times;</button>
            <h3 class="text-2xl font-bold text-yellow-900 text-center magic-title mb-4">–ù–æ–≤–∞—è –ü–æ–º–µ—Ç–∫–∞</h3>
            <div class="space-y-4">
               <textarea id="newStickerText" class="magic-input w-full text-sm" rows="5" placeholder="–¢–µ–∫—Å—Ç –ø–æ–º–µ—Ç–∫–∏..."></textarea>
               <button id="addStickerBtn" class="btn-magic w-full py-2 text-lg mt-2">–ü—Ä–∏–∫–ª–µ–∏—Ç—å üìå</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–Ω—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
    <div id="dayViewModal" class="modal-overlay">
        <div class="magic-parchment modal-content p-6 relative">
            <button id="closeDayViewModalBtn" class="absolute top-2 right-2 text-2xl text-yellow-900 hover:text-yellow-600">&times;</button>
            <h3 id="dayViewTitle" class="text-2xl font-bold text-yellow-900 text-center magic-title mb-4">–ü–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å</h3>
            <div id="dayViewTaskList" class="space-y-3 max-h-[70vh] overflow-y-auto">
                <!-- –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ù–∞—Å—Ç—Ä–æ–µ–∫ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
    <div id="settingsModal" class="modal-overlay">
        <div class="magic-parchment modal-content p-6 relative max-w-md">
            <button id="closeSettingsModalBtn" class="absolute top-2 right-2 text-2xl text-yellow-900 hover:text-yellow-600">&times;</button>
            <h3 class="text-2xl font-bold text-yellow-900 text-center magic-title mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –í–æ–ª—à–µ–±–Ω–∏–∫–∞</h3>
            <div class="space-y-4">
                <div>
                    <label for="nicknameInput" class="magic-label">–í–∞—à –ù–∏–∫–Ω–µ–π–º:</label>
                    <input type="text" id="nicknameInput" class="magic-input w-full text-lg">
                </div>
                <button id="saveNicknameBtn" class="btn-magic w-full py-3 text-lg rounded-lg mt-2">‚ú® –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚ú®</button>
                <hr>
                <div class="text-center text-xs text-gray-600">
                    <span class="font-bold">–í–∞—à ID –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:</span>
                    <strong id="fullCurrentUserIdSettings" class="font-mono cursor-pointer block text-sm" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">...</strong>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 
        –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –î–µ—Ç–∞–ª–µ–π –ó–∞–¥–∞—á–∏
        (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    -->
    <div id="taskDetailModal" class="modal-overlay">
        <div class="magic-parchment modal-content p-6 relative">
            
            <button id="taskDetailEditBtn" class="btn-header-icon absolute top-2 right-14" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            <button id="closeTaskDetailModalBtn" class="btn-header-icon absolute top-2 right-2" title="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
            
            <h3 id="taskDetailTitle" class="text-2xl font-bold text-yellow-900 text-center magic-title mb-4">–î–µ—Ç–∞–ª–∏ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</h3>
            
            <div class="space-y-4">
                
                <!-- –ë–ª–æ–∫ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–í–∏–¥) -->
                <div id="taskDetailViewBlock">
                    <div id="taskDetailStaticMeta" class="mb-4 p-3 bg-white bg-opacity-60 rounded-lg flex flex-wrap gap-x-4 gap-y-2 text-sm">
                        <div><strong class="text-yellow-900">–ú–µ—Ç–∫–∞:</strong> <span id="taskDetailCategory" class="task-tag">...</span></div>
                        <div><strong class="text-yellow-900">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> <span id="taskDetailPriority" class="font-bold">...</span></div>
                        <div><strong class="text-yellow-900">–°—Ä–æ–∫:</strong> <span id="taskDetailDate" class="font-bold">...</span></div>
                        <div><strong class="text-yellow-900">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> <span id="taskDetailAssignee" class="font-bold">...</span></div>
                    </div>

                    <div>
                        <label class="magic-label">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <p id="taskDetailDescriptionText" class="text-gray-800 p-3 bg-white bg-opacity-60 rounded-lg min-h-[50px] whitespace-pre-wrap">...</p>
                    </div>
                </div>

                <!-- –ë–ª–æ–∫ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–°–∫—Ä—ã—Ç) -->
                <div id="taskDetailEditBlock" class="hidden space-y-4">
                    <div>
                        <label for="taskDetailTitleEdit" class="magic-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è:</label>
                        <input type="text" id="taskDetailTitleEdit" class="magic-input w-full text-lg">
                    </div>
                    
                    <div>
                        <label for="taskDetailDescriptionEdit" class="magic-label">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="taskDetailDescriptionEdit" class="magic-input w-full" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
                    </div>

                    <div>
                        <label class="magic-label">–ú–∞–≥–∏—á–µ—Å–∫–∞—è –º–µ—Ç–∫–∞:</label>
                        <div id="taskDetailCategoryEdit" class="flex flex-wrap gap-2">
                            <label class="category-pill cat-students"><input type="radio" name="taskCatDetail" value="students"> –°—Ç—É–¥–µ–Ω—Ç—ã</label>
                            <label class="category-pill cat-home"><input type="radio" name="taskCatDetail" value="home"> –î–æ–º</label>
                            <label class="category-pill cat-projects"><input type="radio" name="taskCatDetail" value="projects"> –ü—Ä–æ–µ–∫—Ç—ã</label>
                            <label class="category-pill cat-hobbies"><input type="radio" name="taskCatDetail" value="hobbies"> –•–æ–±–±–∏</label>
                            <label class="category-pill cat-love"><input type="radio" name="taskCatDetail" value="love"> –õ—é–±–æ–≤—å</label>
                            <label class="category-pill cat-shop"><input type="radio" name="taskCatDetail" value="shop"> –ú–∞–≥–∞–∑–∏–Ω</label>
                            <label class="category-pill cat-docs"><input type="radio" name="taskCatDetail" value="docs"> –î–æ–∫—É–º–µ–Ω—Ç—ã</label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="taskDetailDateEdit" class="magic-label">–°—Ä–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
                            <input id="taskDetailDateEdit" class="magic-input" placeholder="–°—Ä–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è...">
                        </div>
                        <div>
                            <label for="taskDetailPriorityEdit" class="magic-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                            <select id="taskDetailPriorityEdit" class="magic-input">
                                <option value="low">–û–±—ã—á–Ω—ã–π</option>
                                <option value="medium">–í–∞–∂–Ω—ã–π</option>
                                <option value="high">–°—Ä–æ—á–Ω—ã–π!</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="taskDetailAssigneeEdit" class="magic-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</label>
                        <select id="taskDetailAssigneeEdit" class="magic-input">
                            <option value="everyone">–î–ª—è –≤—Å–µ—Ö</option>
                            <option value="me">–¢–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω—è</option>
                            <option value="partner" disabled>–¢–æ–ª—å–∫–æ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞</option>
                        </select>
                    </div>
                </div>

                <!-- –û–±—â–∏–π –±–ª–æ–∫ –ü–æ–¥–∑–∞–¥–∞—á -->
                <div>
                    <label class="magic-label">–ü–æ–¥–∑–∞–¥–∞—á–∏:</label>
                    
                    <div id="subtaskSelectAllContainer" class="hidden justify-end items-center gap-2 pr-2 mb-2">
                        <label for="toggleAllSubtasksCheckbox" class="text-sm font-bold text-yellow-900 cursor-pointer">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</label>
                        <input type="checkbox" id="toggleAllSubtasksCheckbox" class="w-5 h-5 text-blue-600 rounded">
                    </div>

                    <div id="taskDetailSubtaskList" class="space-y-2 p-3 bg-white bg-opacity-60 rounded-lg max-h-40 overflow-y-auto">
                        <!-- –ü–æ–¥–∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                    <div id="taskDetailAddSubtaskContainer" class="flex gap-2 mt-2 hidden">
                        <input type="text" id="taskDetailNewSubtask" class="magic-input flex-grow" placeholder="–ù–æ–≤—ã–π –ø—É–Ω–∫—Ç...">
                        <button id="taskDetailAddSubtaskBtn" class="btn-magic px-4 rounded-lg">+</button>
                    </div>
                </div>

                <button id="taskDetailSaveBtn" class="btn-magic w-full py-3 text-lg rounded-lg mt-2 hidden">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ò–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
    </div>

    <script src="https://npmcdn.com/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- –°–ï–†–í–ò–°–´ FIREBASE ---
            // (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            while (typeof window.firebaseServices === 'undefined') {
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            const {
                auth, db, rtdb, appId,
                onAuthStateChanged,
                createUserWithEmailAndPassword, 
                signInWithEmailAndPassword,     
                signOut,                        
                doc, getDoc, setDoc, 
                addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, Timestamp,
                ref, set, onValue, onDisconnect
            } = window.firebaseServices;

            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–º–µ–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –∏–º–µ–Ω –Ω–∞ –∫–∞—Ä—Ç—É UID <-> –ò–º—è ---
            const KNOWN_USER_MAP = {
              "bm114yHgXOTtjg7JMf60LHrG3X83": "Yura Marev",
              "W79T0QBZ9Pa35wnIFnCvVQBonkQ2": "KoshkaKartoshka"
            };

            // --- –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ---
            let allTasks = []; 
            let allStickers = []; 
            let calendar; 
            let currentUserId = null;
            let currentUserNickname = null; 
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: otherUserInfo —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ò–ú–ï–ù–ò –ø–∞—Ä—Ç–Ω–µ—Ä–∞, 
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: otherUserInfo —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ò–ú–ï–ù–ò –∏ UID –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            let otherUserInfo = { uid: null, nickname: '–û—Ñ—Ñ–ª–∞–π–Ω' };
            let currentFilter = 'active'; 
            let tasksUnsubscribe = null; 
            let stickersUnsubscribe = null; 
            let presenceUnsubscribe = null; 
            let isAppInitialized = false; 
            let currentEditingTaskId = null; 
            let isTaskDetailEditing = false; 
            let currentViewingDate = null; 
            let detailDatePicker; 

            // --- DOM –≠–õ–ï–ú–ï–ù–¢–´ ---
            const authOverlay = document.getElementById('authOverlay');
            const mainAppContainer = document.getElementById('mainAppContainer');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const authTabLogin = document.getElementById('authTabLogin');
            const authTabRegister = document.getElementById('authTabRegister');
            const authError = document.getElementById('authError');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const openTaskModalBtn = document.getElementById('openTaskModalBtn');
            const addTaskBtn = document.getElementById('addTaskBtn'); 
            const taskListEl = document.getElementById('taskList');
            const modal = document.getElementById('addTaskModal');
            const dayViewModal = document.getElementById('dayViewModal');
            const closeTaskModalBtn = document.getElementById('closeTaskModalBtn'); 
            const currentUserDisplayEl = document.getElementById('currentUserDisplay'); 
            const currentUserIndicatorEl = document.getElementById('currentUserIndicator'); 
            const settingsModal = document.getElementById('settingsModal');
            const openSettingsBtn = document.getElementById('openSettingsBtn');
            const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
            const nicknameInput = document.getElementById('nicknameInput');
            const saveNicknameBtn = document.getElementById('saveNicknameBtn');
            const fullCurrentUserIdSettings = document.getElementById('fullCurrentUserIdSettings'); 
            const taskDetailModal = document.getElementById('taskDetailModal');
            const closeTaskDetailModalBtn = document.getElementById('closeTaskDetailModalBtn');
            
            const taskDetailTitle = document.getElementById('taskDetailTitle');
            const taskDetailViewBlock = document.getElementById('taskDetailViewBlock');
            const taskDetailEditBlock = document.getElementById('taskDetailEditBlock');
            const taskDetailStaticMeta = document.getElementById('taskDetailStaticMeta');
            const taskDetailCategory = document.getElementById('taskDetailCategory');
            const taskDetailPriority = document.getElementById('taskDetailPriority');
            const taskDetailDate = document.getElementById('taskDetailDate');
            const taskDetailAssignee = document.getElementById('taskDetailAssignee');
            const taskDetailDescriptionText = document.getElementById('taskDetailDescriptionText'); 
            
            const taskDetailTitleEdit = document.getElementById('taskDetailTitleEdit');
            const taskDetailDescriptionEdit = document.getElementById('taskDetailDescriptionEdit'); 
            const taskDetailCategoryEdit = document.getElementById('taskDetailCategoryEdit');
            const taskDetailDateEdit = document.getElementById('taskDetailDateEdit');
            const taskDetailPriorityEdit = document.getElementById('taskDetailPriorityEdit');
            const taskDetailAssigneeEdit = document.getElementById('taskDetailAssigneeEdit');
            
            const taskDetailSubtaskList = document.getElementById('taskDetailSubtaskList');
            const taskDetailNewSubtask = document.getElementById('taskDetailNewSubtask');
            const taskDetailAddSubtaskContainer = document.getElementById('taskDetailAddSubtaskContainer'); 
            const taskDetailAddSubtaskBtn = document.getElementById('taskDetailAddSubtaskBtn');
            const taskDetailSaveBtn = document.getElementById('taskDetailSaveBtn');
            const taskDetailEditBtn = document.getElementById('taskDetailEditBtn'); 
            const toggleAllSubtasksCheckbox = document.getElementById('toggleAllSubtasksCheckbox'); 
            
            const newTaskSubtaskList = document.getElementById('newTaskSubtaskList');
            const newTaskNewSubtask = document.getElementById('newTaskNewSubtask');
            const newTaskAddSubtaskBtn = document.getElementById('newTaskAddSubtaskBtn');
            const taskAssigneeSelect = document.getElementById('taskAssignee');
            
            const stickerBackdrop = document.getElementById('stickerBackdrop');
            const stickerModal = document.getElementById('stickerModal');
            const openStickerModalBtn = document.getElementById('openStickerModalBtn');
            const closeStickerModalBtn = document.getElementById('closeStickerModalBtn');
            const newStickerText = document.getElementById('newStickerText');
            const addStickerBtn = document.getElementById('addStickerBtn');
            
            const navButtons = document.querySelectorAll('.nav-btn');
            const views = document.querySelectorAll('.view-container');
            const calendarViewEl = document.getElementById('calendarView'); 
            const filterActiveBtn = document.getElementById('filterActive');
            const filterHighBtn = document.getElementById('filterHigh');
            const filterCompletedBtn = document.getElementById('filterCompleted');
            const hatSortBtn = document.getElementById('hatSortBtn');
            
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï iOS: –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            let isStickerDragging = false;
            let currentDraggingSticker = null;
            let stickerOffsetX = 0;
            let stickerOffsetY = 0;

            /* –ò–∫–æ–Ω–∫–∏ SVG (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
            const iconPlay = `<svg viewBox="0 0 20 20" fill="currentColor"><path d="M17.4,10.4L5.8,17.6C5.5,17.8,5.1,17.7,4.9,17.4C4.8,17.2,4.8,16.9,4.9,16.7L8,10L4.9,3.3C4.8,3.1,4.8,2.8,4.9,2.6C5.2,2.3,5.5,2.2,5.8,2.4L17.4,9.6C17.7,9.8,17.8,10.2,17.6,10.4C17.6,10.4,17.5,10.4,17.4,10.4z"/></svg>`;
            const iconCheck = `<svg viewBox="0 0 20 20" fill="currentColor"><path d="M18.5,3.1l-9.8,9.8L4.3,8.4C4,8.1,3.5,8.1,3.2,8.4c-0.3,0.3-0.3,0.8,0,1.1l5.1,5.1c0.1,0.1,0.3,0.2,0.5,0.2s0.4-0.1,0.5-0.2l10.6-10.6c0.3-0.3,0.3-0.8,0-1.1C19.3,2.8,18.8,2.8,18.5,3.1z"/></svg>`;
            const iconUndo = `<svg viewBox="0 0 20 20" fill="currentColor"><path d="M16.5,10.5h-5c-0.3,0-0.5-0.2-0.5-0.5s0.2-0.5,0.5-0.5h5c0.3,0,0.5,0.2,0.5,0.5S16.8,10.5,16.5,10.5z M11.5,12.5h-5c-0.3,0-0.5-0.2-0.5-0.5s0.2-0.5,0.5-0.5h5c0.3,0,0.5,0.2,0.5,0.5S11.8,12.5,11.5,12.5z M10,18.5C5.3,18.5,1.5,14.7,1.5,10S5.3,1.5,10,1.5c2.4,0,4.6,1,6.2,2.6l-1.4,1.4c-0.2,0.2-0.2,0.5,0,0.7s0.5,0.2,0.7,0l3.2-3.2c0.2-0.2,0.2-0.5,0-0.7L15.4,0.7c-0.2-0.2-0.5-0.2-0.7,0s-0.2,0.5,0,0.7l1.5,1.5C14.6,1.4,12.4,0.5,10,0.5C4.8,0.5,0.5,4.8,0.5,10s4.3,9.5,9.5,9.5s9.5-4.3,9.5-9.5c0-0.3-0.2-0.5-0.5-0.5s-0.5,0.2-0.5,0.5C18.5,14.7,14.7,18.5,10,18.5z"/></svg>`;
            const iconDelete = `<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10.7,10l4.6-4.6c0.2-0.2,0.2-0.5,0-0.7s-0.5-0.2-0.7,0L10,9.3L5.4,4.7c-0.2-0.2-0.5-0.2-0.7,0s-0.2,0.5,0,0.7L9.3,10l-4.6,4.6c-0.2,0.2-0.2,0.5,0,0.7C4.8,15.4,4.9,15.5,5,15.5s0.2,0,0.4-0.1L10,10.7l4.6,4.6c0.1,0.1,0.2,0.1,0.4,0.1s0.3-0.1,0.4-0.2c0.2-0.2,0.2-0.5,0-0.7L10.7,10z"/></svg>`;

            // --- –ê–£–î–ò–û (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            let audioInit = false;
            let brownNoise = null;
            const initAudio = async () => {
                if (audioInit) return;
                try {
                    await Tone.start();
                    window.addSynth = new Tone.PolySynth(Tone.Synth, { volume: -10 }).toDestination();
                    window.completeSynth = new Tone.MetalSynth({ volume: -15, harmonicity: 3.1 }).toDestination();
                    window.hatSynth = new Tone.PluckSynth({ volume: -5 }).toDestination();
                    window.alarmSynth = new Tone.Synth({ volume: -5 }).toDestination();
                    brownNoise = new Tone.Noise("brown").toDestination();
                    const filter = new Tone.AutoFilter({ frequency: "8m", min: 800, max: 3000 }).connect(Tone.Master);
                    brownNoise.connect(filter); filter.start();
                    brownNoise.volume.value = -Infinity; brownNoise.start();
                    audioInit = true;
                } catch (e) {
                    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ:", e);
                }
            };

            // --- –¶–í–ï–¢–ê –ò –ò–ú–ï–ù–ê –ö–ê–¢–ï–ì–û–†–ò–ô (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            const catColors = {
                students: '#3b82f6', home: '#d97706', projects: '#9333ea',
                hobbies: '#10b981', love: '#ec4899', shop: '#eab308', docs: '#64748b'
            };
            const catNames = {
                students: '–°—Ç—É–¥–µ–Ω—Ç—ã', home: '–î–æ–º', projects: '–ü—Ä–æ–µ–∫—Ç—ã',
                hobbies: '–•–æ–±–±–∏', love: '–õ—é–±–æ–≤—å', shop: '–ú–∞–≥–∞–∑–∏–Ω', docs: '–î–æ–∫—É–º–µ–Ω—Ç—ã'
            };
            
            // --- –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            
            authTabLogin.addEventListener('click', () => {
                authTabLogin.classList.add('active');
                authTabRegister.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                authError.textContent = '';
            });
            authTabRegister.addEventListener('click', () => {
                authTabRegister.classList.add('active');
                authTabLogin.classList.remove('active');
                registerForm.style.display = 'block';
                loginForm.style.display = 'none';
                authError.textContent = '';
            });

            function showAuthError(error) {
                console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error.code, error.message);
                switch (error.code) {
                    case 'auth/invalid-email': authError.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email'; break;
                    case 'auth/user-not-found': authError.textContent = '–í–æ–ª—à–µ–±–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'; break;
                    case 'auth/wrong-password': authError.textContent = '–ù–µ–≤–µ—Ä–Ω–æ–µ —Ç–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ'; break;
                    case 'auth/email-already-in-use': authError.textContent = '–≠—Ç–æ—Ç email —É–∂–µ –∑–∞–Ω—è—Ç'; break;
                    case 'auth/weak-password': authError.textContent = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π'; break;
                    case 'auth/passwords-not-match': authError.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!'; break;
                    case 'auth/missing-nickname': authError.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º!'; break; 
                    default: authError.textContent = '–û—à–∏–±–∫–∞! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                }
            }

            registerBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                const nickname = document.getElementById('registerNickname').value.trim(); 

                if (password !== confirmPassword) {
                    showAuthError({ code: 'auth/passwords-not-match' });
                    return;
                }
                
                if (!nickname) { 
                    showAuthError({ code: 'auth/missing-nickname' });
                    return;
                }
                
                authError.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Å–≤–∏—Ç–∫–∞...';
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, user.uid);
                    await setDoc(userDocRef, { 
                        nickname: nickname, 
                        email: email 
                    });
                    authError.textContent = '';
                } catch (error) {
                    showAuthError(error);
                }
            });

            loginBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                authError.textContent = '–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–∞–ª–∞...';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    authError.textContent = '';
                } catch (error) {
                    showAuthError(error);
                }
            });

            logoutBtn.addEventListener('click', () => {
                signOut(auth).catch(err => console.error("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", err));
            });
            
            
            // --- –ö–ê–õ–ï–ù–î–ê–†–¨ (INIT) (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            const initCalendar = () => {
                const calendarEl = document.getElementById('calendar');
                if (calendar) {
                    calendar.render(); 
                    return;
                }
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ru',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: '' 
                    },
                    height: 'auto',
                    
                    events: (info, successCallback) => {
                        successCallback([]); 
                    },

                    dateClick: (arg) => {
                        showDayViewModal(arg.date);
                    },

                    datesSet: (arg) => {
                        console.log("Calendar datesSet: running updateCalendarCounters()");
                        updateCalendarCounters();
                    }
                });
                calendar.render();
            };
            
            // --- –§–£–ù–ö–¶–ò–Ø: updateCalendarCounters (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            function updateCalendarCounters() {
                if (!calendar) return; 

                const dayCells = document.querySelectorAll('.fc-daygrid-day');

                dayCells.forEach(cell => {
                    const dateStr = cell.getAttribute('data-date');
                    if (!dateStr) return;

                    const cellDate = new Date(dateStr + 'T00:00:00'); 
                    
                    const existingCounter = cell.querySelector('.day-task-count');
                    if (existingCounter) {
                        existingCounter.remove();
                    }

                    const dayStart = new Date(cellDate.getFullYear(), cellDate.getMonth(), cellDate.getDate());
                    const dayEnd = new Date(dayStart.getFullYear(), dayStart.getMonth(), dayStart.getDate(), 23, 59, 59, 999);

                    const tasksForDay = allTasks.filter(t => 
                        t.date && t.date >= dayStart && t.date <= dayEnd
                    );

                    if (tasksForDay.length > 0) {
                        const total = tasksForDay.length;
                        const completed = tasksForDay.filter(t => t.status === 'completed').length;
                        
                        let countClass = 'day-task-count';
                        if (completed === total) {
                            countClass = 'day-task-count day-task-count-completed';
                        } else if (completed > 0) {
                            countClass = 'day-task-count day-task-count-mixed';
                        }

                        const counterEl = document.createElement('div');
                        counterEl.className = countClass;
                        counterEl.innerHTML = `${completed} / ${total}`;
                        
                        const frame = cell.querySelector('.fc-daygrid-day-frame');
                        if (frame) {
                            frame.appendChild(counterEl);
                        } else {
                            cell.appendChild(counterEl);
                        }
                    }
                });
            }

            // –ì–õ–ê–í–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ –°–û–°–¢–û–Ø–ù–ò–Ø AUTH
            // (–ò–ó–ú–ï–ù–ï–ù: –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –ø–æ UID)
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω:", user.uid);
                    currentUserId = user.uid;
                    
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, user.uid);
                    let nickname = `–í–æ–ª—à–µ–±–Ω–∏–∫ ${user.uid.substring(0, 4)}`; 
                    try {
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            nickname = userDoc.data().nickname;
                        } else {
                            console.warn("–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º...");
                            await setDoc(userDocRef, { nickname: nickname, email: user.email });
                        }
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∏–∫–Ω–µ–π–º–∞:", e);
                    }
                    
                    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –õ–æ–≥–∏–∫–∞ –¥–ª—è –∏–º–µ–Ω –∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ ---
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π" –Ω–∏–∫–Ω–µ–π–º –∏–∑ –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç, —á—Ç–æ –∏–∑ –ë–î
                    currentUserNickname = KNOWN_USER_MAP[currentUserId] || nickname; 
                    currentUserDisplayEl.textContent = currentUserNickname; 
                    currentUserIndicatorEl.classList.remove('presence-offline');
                    currentUserIndicatorEl.classList.add('presence-online');

                    // –ù–∞—Ö–æ–¥–∏–º UID "–¥—Ä—É–≥–æ–≥–æ" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–∞—Ä—Ç—ã
                    const otherUserId = Object.keys(KNOWN_USER_MAP).find(uid => uid !== currentUserId);
                    const otherUserNameEl = document.getElementById('otherUserName');
                    
                    if (otherUserId) {
                        const otherUserNickname = KNOWN_USER_MAP[otherUserId]; // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –ø–æ –µ–≥–æ UID
                        otherUserNameEl.textContent = otherUserNickname;
                        
                        // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º UID –∏ –ò–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞.
                        // –¢–µ–ø–µ—Ä—å listenForOtherUserPresence –±—É–¥–µ—Ç –∑–Ω–∞—Ç—å, –∫–æ–≥–æ —Å–ª—É—à–∞—Ç—å.
                        otherUserInfo.nickname = otherUserNickname;
                        otherUserInfo.uid = otherUserId; 
                    } else {
                        // –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—Å—è –∫—Ç–æ-—Ç–æ —Ç—Ä–µ—Ç–∏–π
                        otherUserNameEl.textContent = "–ü–∞—Ä—Ç–Ω–µ—Ä (–Ω–µ –Ω–∞–π–¥–µ–Ω)";
                        otherUserInfo.nickname = "–û—Ñ—Ñ–ª–∞–π–Ω";
                        otherUserInfo.uid = null;
                    }
                    // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

                    fullCurrentUserIdSettings.textContent = user.uid;
                    fullCurrentUserIdSettings.onclick = () => {
                        const textArea = document.createElement("textarea");
                        textArea.value = user.uid;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            fullCurrentUserIdSettings.title = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!";
                            setTimeout(() => fullCurrentUserIdSettings.title = "–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", 2000);
                        } catch (err) { console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID', err); }
                        document.body.removeChild(textArea);
                    };

                    mainAppContainer.style.display = 'block';
                    authOverlay.style.display = 'none';

                    if (!isAppInitialized) {
                        listenForTasks();
                        listenForStickers(); 
                        setupPresence(); 
                        listenForOtherUserPresence(); // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –∏—â–µ—Ç –ø–æ –∏–º–µ–Ω–∏
                        initCalendar(); 
                        isAppInitialized = true;
                    }

                } else {
                    console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–æ—à–µ–ª.");
                    currentUserId = null;
                    currentUserNickname = null; 
                    isAppInitialized = false;

                    mainAppContainer.style.display = 'none';
                    authOverlay.style.display = 'flex'; 

                    if (tasksUnsubscribe) {
                        tasksUnsubscribe();
                        tasksUnsubscribe = null;
                        console.log("–û—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∑–∞–¥–∞—á (tasks)");
                    }
                    if (stickersUnsubscribe) { 
                        stickersUnsubscribe();
                        stickersUnsubscribe = null;
                        console.log("–û—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –ø–æ–º–µ—Ç–æ–∫ (stickers)");
                    }
                    if (presenceUnsubscribe) {
                        presenceUnsubscribe();
                        presenceUnsubscribe = null;
                        console.log("–û—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è (presence)");
                    }
                    
                    allTasks = [];
                    allStickers = []; 
                    renderTasks(); 
                    stickerBackdrop.innerHTML = ''; 
                    
                    if (calendar) {
                        calendar.destroy();
                        calendar = null;
                        console.log("–ö–∞–ª–µ–Ω–¥–∞—Ä—å —É–Ω–∏—á—Ç–æ–∂–µ–Ω –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ.");
                    }
                    
                    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–±—Ä–æ—Å –∏–º–µ–Ω –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ ---
                    document.getElementById('otherUserName').textContent = "–û—Ñ—Ñ–ª–∞–π–Ω";
                    document.getElementById('otherUserIndicator').classList.remove('presence-online');
                    document.getElementById('otherUserIndicator').classList.add('presence-offline');
                    otherUserInfo = { uid: null, nickname: '–û—Ñ—Ñ–ª–∞–π–Ω' }; // –°–±—Ä–æ—Å
                    
                    currentUserDisplayEl.textContent = "..."; 
                    currentUserIndicatorEl.classList.remove('presence-online'); 
                    currentUserIndicatorEl.classList.add('presence-offline'); 
                    fullCurrentUserIdSettings.textContent = "...";
                }
            });

            // (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            function setupPresence() {
                if (!currentUserId || !currentUserNickname) return; 
                
                const userStatusRef = ref(rtdb, `/artifacts/${appId}/presence/${currentUserId}`);
                const userInfo = {
                    online: true,
                    name: currentUserNickname, 
                    lastSeen: new Date().toISOString()
                };
                
                set(userStatusRef, userInfo);
                
                onDisconnect(userStatusRef).set({
                    ...userInfo,
                    online: false,
                    lastSeen: new Date().toISOString()
                });
            }

            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –õ–æ–≥–∏–∫–∞ Presence —Å–ª—É—à–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π UID –ø–∞—Ä—Ç–Ω–µ—Ä–∞ ---
            function listenForOtherUserPresence() {
                if (presenceUnsubscribe) presenceUnsubscribe(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å
                
                // –ü–æ–ª—É—á–∞–µ–º UID –ø–∞—Ä—Ç–Ω–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ onAuthStateChanged
                const otherUserId = otherUserInfo.uid; 
                
                if (!currentUserId || !otherUserId) {
                    console.warn("–ù–µ –º–æ–≥—É –Ω–∞—á–∞—Ç—å —Å–ª—É—à–∞—Ç—å presence, otherUserId –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ñ—Ñ–ª–∞–π–Ω, –µ—Å–ª–∏ –º—ã –Ω–µ –∑–Ω–∞–µ–º, –∫—Ç–æ –ø–∞—Ä—Ç–Ω–µ—Ä
                    document.getElementById('otherUserName').textContent = otherUserInfo.nickname || "–û—Ñ—Ñ–ª–∞–π–Ω";
                    document.getElementById('otherUserIndicator').classList.add('presence-offline');
                    document.getElementById('otherUserIndicator').classList.remove('presence-online');
                    updateAssigneeSelectors(); // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–±–æ—Ä –ø–∞—Ä—Ç–Ω–µ—Ä–∞
                    return;
                }

                // –°–ª—É—à–∞–µ–º *–Ω–∞–ø—Ä—è–º—É—é* —É–∑–µ–ª –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –ø–æ –µ–≥–æ UID
                const partnerPresenceRef = ref(rtdb, `/artifacts/${appId}/presence/${otherUserId}`);
                
                console.log(`–ù–∞—á–∏–Ω–∞—é –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å presence –¥–ª—è UID: ${otherUserId}`);
                
                presenceUnsubscribe = onValue(partnerPresenceRef, (snapshot) => {
                    const otherUserIndicator = document.getElementById('otherUserIndicator');
                    const otherUserNameEl = document.getElementById('otherUserName');
                    const partnerData = snapshot.val();

                    if (partnerData) {
                        // –î–∞–Ω–Ω—ã–µ –æ –ø–∞—Ä—Ç–Ω–µ—Ä–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ RTDB
                        otherUserNameEl.textContent = partnerData.name; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –∏–∑ RTDB (—Å–∞–º–æ–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ)
                        
                        if (partnerData.online) {
                            otherUserIndicator.classList.remove('presence-offline');
                            otherUserIndicator.classList.add('presence-online');
                            otherUserInfo.uid = otherUserId; // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º UID
                            otherUserInfo.nickname = partnerData.name; // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∫–Ω–µ–π–º –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π
                        } else {
                            // –ü–∞—Ä—Ç–Ω–µ—Ä –æ—Ñ—Ñ–ª–∞–π–Ω
                            otherUserIndicator.classList.add('presence-offline');
                            otherUserIndicator.classList.remove('presence-online');
                            otherUserInfo.uid = otherUserId; // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º UID
                            otherUserInfo.nickname = partnerData.name; // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∫–Ω–µ–π–º
                        }
                    } else {
                        // –ü–∞—Ä—Ç–Ω–µ—Ä –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞—Ö–æ–¥–∏–ª, –µ–≥–æ —É–∑–ª–∞ –≤ /presence –Ω–µ—Ç
                        console.log(`–ü–∞—Ä—Ç–Ω–µ—Ä ${otherUserId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ /presence`);
                        otherUserNameEl.textContent = otherUserInfo.nickname; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –∏–∑ –Ω–∞—à–µ–π –∫–∞—Ä—Ç—ã
                        otherUserIndicator.classList.add('presence-offline');
                        otherUserIndicator.classList.remove('presence-online');
                        // otherUserInfo.uid —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –ø–∞—Ä—Ç–Ω–µ—Ä –æ—Ñ—Ñ–ª–∞–π–Ω
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –≤ –º–æ–¥–∞–ª–∫–∞—Ö
                    updateAssigneeSelectors();
                });
            }
            
            // (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            function updateAssigneeSelectors() {
                const partnerExists = otherUserInfo.uid !== null; // –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ UID
                const partnerName = (otherUserInfo.nickname !== '–û—Ñ—Ñ–ª–∞–π–Ω') ? otherUserInfo.nickname : '–ü–∞—Ä—Ç–Ω–µ—Ä';

                // –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è
                const createPartnerOption = taskAssigneeSelect.querySelector('option[value="partner"]');
                createPartnerOption.textContent = `–¢–æ–ª—å–∫–æ –¥–ª—è ${partnerName}`;
                createPartnerOption.disabled = !partnerExists;

                // –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const editPartnerOption = taskDetailAssigneeEdit.querySelector('option[value="partner"]');
                editPartnerOption.textContent = `–¢–æ–ª—å–∫–æ –¥–ª—è ${partnerName}`;
                editPartnerOption.disabled = !partnerExists;
            }

            
            // --- –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            
            function showView(viewId) {
                views.forEach(view => view.classList.add('hidden'));
                navButtons.forEach(btn => btn.classList.remove('active'));
                
                const viewToShow = document.getElementById(viewId);
                const buttonToActivate = document.getElementById('nav-' + viewId.replace('View', ''));
                
                if (viewToShow) viewToShow.classList.remove('hidden');
                if (buttonToActivate) buttonToActivate.classList.add('active');
                
                if (viewId === 'calendarView') {
                    if (!calendar) {
                        initCalendar();
                    } else {
                        calendar.render();
                    }
                }
            }
            
            navButtons.forEach(button => {
                if (button.id === 'openStickerModalBtn') return; 
                
                button.addEventListener('click', () => {
                    const viewId = button.id.replace('nav-', '') + 'View';
                    showView(viewId);
                });
            });
            showView('tasksView');
            

            // --- –õ–û–ì–ò–ö–ê –ó–ê–î–ê–ß (FIRESTORE) (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            function listenForTasks() {
                if (!currentUserId) return;
                if (tasksUnsubscribe) tasksUnsubscribe(); 
                
                const tasksCol = collection(db, `/artifacts/${appId}/public/data/tasks`);
                tasksUnsubscribe = onSnapshot(tasksCol, (snapshot) => {
                    allTasks = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date ? (data.date.toDate ? data.date.toDate() : new Date(data.date)) : null
                        };
                    });
                    
                    allTasks.sort((a, b) => {
                        const statusOrder = { 'inProgress': 1, 'pending': 2, 'completed': 3 };
                        if (statusOrder[a.status] !== statusOrder[b.status]) {
                            return statusOrder[a.status] - statusOrder[b.status];
                        }
                        if (a.date && !b.date) return -1;
                        if (!a.date && b.date) return 1;
                        if (!a.date && !b.date) return 0;
                        return a.date - b.date;
                    });
                    
                    renderTasks();
                    
                    if(calendar) {
                        console.log("OnSnapshot: running updateCalendarCounters()...");
                        updateCalendarCounters(); 
                    }
                    
                    if (dayViewModal.style.display === 'flex' && currentViewingDate) {
                        console.log("OnSnapshot: Refreshing open day view modal...");
                        showDayViewModal(currentViewingDate);
                    }
                    
                    if (taskDetailModal.style.display === 'flex' && currentEditingTaskId) {
                        console.log("OnSnapshot: Refreshing open task detail modal...");
                        const updatedTask = allTasks.find(t => t.id === currentEditingTaskId);
                        if (updatedTask) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            if (!isTaskDetailEditing) {
                                populateTaskDetailView(updatedTask);
                            }
                            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–∑–∞–¥–∞—á–∏ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
                            renderSubtasks(updatedTask.subtasks || [], isTaskDetailEditing);
                        } else {
                            // –ó–∞–¥–∞—á–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞, –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                            taskDetailModal.style.display = 'none';
                            currentEditingTaskId = null;
                        }
                    }
                }, (error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á:", error);
                    taskListEl.innerHTML = '<p class="text-center text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</p>';
                });
            }

            // --- –†–ï–ù–î–ï–†–ò–ù–ì –ó–ê–î–ê–ß (–°–ü–ò–°–û–ö) (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            const renderTasks = () => {
                if (!taskListEl) {
                    console.error("taskListEl –Ω–µ –Ω–∞–π–¥–µ–Ω! HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∞.");
                    return;
                }
                
                taskListEl.innerHTML = '';
                
                let tasksToRender = [];
                
                if (currentFilter === 'completed') {
                    tasksToRender = allTasks.filter(t => t.status === 'completed');
                } else if (currentFilter === 'high') {
                    tasksToRender = allTasks.filter(t => (t.status === 'pending' || t.status === 'inProgress') && t.priority === 'high');
                } else {
                    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 'active'
                    tasksToRender = allTasks.filter(t => t.status === 'pending' || t.status === 'inProgress');
                }

                if (tasksToRender.length === 0) {
                    let message = "–°–≤–∏—Ç–æ–∫ –ø—É—Å—Ç...";
                    if (currentFilter === 'completed') message = "–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç...";
                    if (currentFilter === 'high') message = "–°—Ä–æ—á–Ω—ã—Ö –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π –Ω–µ—Ç...";
                    taskListEl.innerHTML = `<p class="text-center text-gray-500 italic">${message}</p>`;
                } else {
                    tasksToRender.forEach(task => taskListEl.appendChild(createTaskElement(task)));
                }
            };

            // (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            function createTaskElement(task) {
                const el = document.createElement('div');
                const tagColor = catColors[task.category] || '#666';
                const taskDate = task.date ? new Date(task.date) : null;
                const dateString = taskDate ? taskDate.toLocaleString('ru', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' }) : '';

                let buttons = '';
                let statusIndicator = '';

                if (task.status === 'pending') {
                    buttons = `
                        <button class="task-spell-btn bg-blue-600 text-white border-blue-700 hover:bg-blue-700" onclick="window.startTask('${task.id}')" title="–ù–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ">${iconPlay}</button>
                    `;
                } else if (task.status === 'inProgress') {
                    statusIndicator = `<span class="text-xs font-bold text-purple-700 animate-pulse ml-2">(–í –ø—Ä–æ—Ü–µ—Å—Å–µ...)</span>`;
                    buttons = `
                        <button class="task-spell-btn bg-green-600 text-white border-green-700 hover:bg-green-700" onclick="window.completeTask('${task.id}')" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">${iconCheck}</button>
                    `;
                } else if (task.status === 'completed') {
                    buttons = `
                        <button class="task-spell-btn bg-gray-500 text-white border-gray-600 hover:bg-gray-600" onclick="window.reactivateTask('${task.id}')" title="–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞">${iconUndo}</button>
                    `;
                }
                buttons += ` <button class="task-spell-btn bg-red-600 text-white border-red-700 hover:bg-red-700" onclick="window.deleteTask('${task.id}')" title="–£–¥–∞–ª–∏—Ç—å">${iconDelete}</button>`;

                let assigneeTag = '';
                if (task.assignedTo && task.assignedTo.uid !== 'everyone') {
                    assigneeTag = `<span class="assignee-tag">–î–ª—è: ${task.assignedTo.nickname}</span>`;
                }
                
                let descriptionEl = '';
                if (task.description) {
                    descriptionEl = `<p class="text-xs text-gray-700 mt-1 pl-1 truncate">${task.description}</p>`;
                }

                el.className = `task-item p-3 bg-white bg-opacity-80 rounded-lg shadow-sm priority-${task.priority} status-${task.status} mb-2`;
                el.innerHTML = `
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-grow min-w-0"> <!-- min-w-0 –¥–ª—è —Ä–∞–±–æ—Ç—ã truncate -->
                            <div>
                                <span class="task-tag" style="background-color: ${tagColor}">${catNames[task.category]}</span>
                                <span class="text-gray-900 font-medium cursor-pointer hover:underline" onclick="window.showTaskDetails('${task.id}')">${task.text}</span>
                                ${statusIndicator}
                                ${assigneeTag}
                            </div>
                            ${descriptionEl} <!-- –û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å—é–¥–∞ -->
                            ${taskDate ? `<div class="text-xs text-yellow-900 font-bold mt-1">üìÖ ${dateString}</div>` : ''}
                        </div>
                        <div class="flex gap-2 flex-shrink-0">
                            ${buttons}
                        </div>
                    </div>
                `;
                return el;
            }

            // (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            window.startTask = async (id) => {
                if (!currentUserId) return;
                const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, id);
                try {
                    await updateDoc(taskRef, { status: 'inProgress' });
                } catch (e) { console.error("–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞ –∑–∞–¥–∞—á–∏:", e); }
            };
            // (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            window.completeTask = async (id) => {
                if (!currentUserId) return;
                const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, id);
                try {
                    await updateDoc(taskRef, { status: 'completed' });
                    if (audioInit) window.completeSynth.triggerAttackRelease("C6", "8n");
                    confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 } });
                } catch (e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:", e); }
            };
            // (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            window.reactivateTask = async (id) => {
                if (!currentUserId) return;
                const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, id);
                try {
                    await updateDoc(taskRef, { status: 'pending' });
                } catch (e) { console.error("–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏:", e); }
            };
            // (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            window.deleteTask = async (id) => {
                if (!currentUserId) return;
                const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, id);
                try {
                    await deleteDoc(taskRef);
                } catch (e) { console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:", e); }
            };

            
            // --- –§–£–ù–ö–¶–ò–Ø: –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–Ω—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            function showDayViewModal(date) {
                currentViewingDate = date; 

                const dateCopy = new Date(date.getTime());
                const dayStart = new Date(dateCopy.setHours(0, 0, 0, 0));
                const dayEnd = new Date(dateCopy.setHours(23, 59, 59, 999));

                const tasksForDay = allTasks
                    .filter(t => t.date && t.date >= dayStart && t.date <= dayEnd)
                    .sort((a, b) => a.date - b.date); 
                
                document.getElementById('dayViewTitle').textContent = `–ü–ª–∞–Ω –Ω–∞: ${date.toLocaleDateString('ru', {day: 'numeric', month: 'long', year: 'numeric'})}`;
                const dayTaskListEl = document.getElementById('dayViewTaskList');
                dayTaskListEl.innerHTML = '';

                if (tasksForDay.length === 0) {
                    dayTaskListEl.innerHTML = '<p class="text-center text-gray-500 italic">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π –Ω–µ—Ç.</p>';
                } else {
                    tasksForDay.forEach(task => {
                        const el = document.createElement('div');
                        el.className = `p-3 rounded-lg flex items-center gap-3 status-${task.status} task-item`;
                        const tagColor = catColors[task.category] || '#666';
                        
                        let assigneeTag = '';
                        if (task.assignedTo && task.assignedTo.uid !== 'everyone') {
                            assigneeTag = `<span class="assignee-tag !ml-0 !mr-2">${task.assignedTo.nickname}</span>`;
                        }
                        
                        el.innerHTML = `
                            <div class="flex-shrink-0 w-20 text-center font-bold text-yellow-900 bg-yellow-100 p-2 rounded">
                                ${task.date.toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                            <div class="flex-grow">
                                ${assigneeTag}
                                <span class="task-tag" style="background-color: ${tagColor}">${catNames[task.category]}</span>
                                <span class="font-medium cursor-pointer hover:underline" onclick="window.showTaskDetails('${task.id}')">${task.text}</span>
                                ${task.status === 'inProgress' ? '<span class="text-xs font-bold text-purple-700 ml-2">(–í –ø—Ä–æ—Ü–µ—Å—Å–µ...)</span>' : ''}
                                ${task.status === 'completed' ? '<span class="text-xs font-bold text-green-700 ml-2">(–ì–æ—Ç–æ–≤–æ)</span>' : ''}
                            </div>
                        `;
                        const controls = document.createElement('div');
                        controls.className = 'flex gap-2 flex-shrink-0';
                        if (task.status === 'pending') {
                             controls.innerHTML = `<button class="task-spell-btn bg-blue-600 text-white border-blue-700 hover:bg-blue-700" onclick="window.startTask('${task.id}')" title="–ù–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ">${iconPlay}</button>`;
                        } else if (task.status === 'inProgress') {
                             controls.innerHTML = `<button class="task-spell-btn bg-green-600 text-white border-green-700 hover:bg-green-700" onclick="window.completeTask('${task.id}')" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">${iconCheck}</button>`;
                        } else if (task.status === 'completed') {
                             controls.innerHTML = `<button class="task-spell-btn bg-gray-500 text-white border-gray-600 hover:bg-gray-600" onclick="window.reactivateTask('${task.id}')" title="–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞">${iconUndo}</button>`;
                        }
                        controls.innerHTML += ` <button class="task-spell-btn bg-red-600 text-white border-red-700 hover:bg-red-700" onclick="window.deleteTask('${task.id}')" title="–£–¥–∞–ª–∏—Ç—å">${iconDelete}</button>`;
                        
                        el.appendChild(controls);
                        dayTaskListEl.appendChild(el);
                    });
                }
                
                dayViewModal.style.display = 'flex';
            }
            document.getElementById('closeDayViewModalBtn').addEventListener('click', () => {
                dayViewModal.style.display = 'none';
                currentViewingDate = null; 
            });
            dayViewModal.addEventListener('click', (e) => {
                if(e.target === dayViewModal) {
                    dayViewModal.style.display = 'none';
                    currentViewingDate = null; 
                }
            });


            // --- –¢–ê–ô–ú–ï–† ---
            // (–ò–ó–ú–ï–ù–ï–ù: –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è type="text")
            let timerTime = 25 * 60; let defaultTime = 25; let timerInterval = null; let isRunning = false;
            const timerDisplay = document.getElementById('timerDisplay'); 
            const timerInput = document.getElementById('timerInput');
            const timerStatus = document.getElementById('timerStatus'); 
            const startTimerBtn = document.getElementById('startTimerBtn');
            
            const updateDisplay = () => {
                const m = Math.floor(timerTime / 60).toString().padStart(2, '0');
                const s = (timerTime % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${m}:${s}`;
            };

            // –ò–ó–ú–ï–ù–ï–ù–ò–ï iOS: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è type="text"
            document.getElementById('timerSettingsBtn').addEventListener('click', () => {
                if (isRunning) return; 
                const isEditing = !timerInput.classList.contains('hidden');
                if (isEditing) {
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è type="text"
                    let newVal = parseInt(timerInput.value, 10);
                    if (!isNaN(newVal) && newVal > 0 && newVal <= 180) { 
                        defaultTime = newVal; 
                    } else {
                        // –ï—Å–ª–∏ –≤–≤–µ–ª–∏ –µ—Ä—É–Ω–¥—É, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        timerInput.value = defaultTime;
                    }
                    timerTime = defaultTime * 60; 
                    updateDisplay(); 
                    
                    timerInput.classList.add('hidden'); 
                    timerDisplay.classList.remove('opacity-0');
                } else {
                    timerInput.value = defaultTime; 
                    timerInput.classList.remove('hidden');
                    timerInput.focus(); 
                    timerDisplay.classList.add('opacity-0');
                }
            });
            
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï iOS: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤–≤–æ–¥–∞
            timerInput.addEventListener('input', (e) => {
                // –£–¥–∞–ª—è–µ–º –≤—Å—ë, —á—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ü–∏—Ñ—Ä–æ–π
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            timerInput.addEventListener('blur', () => { 
                if(!timerInput.classList.contains('hidden')) {
                    document.getElementById('timerSettingsBtn').click(); 
                }
            });
            timerInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') timerInput.blur(); });
            
            // (–õ–æ–≥–∏–∫–∞ Start/Reset –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            startTimerBtn.addEventListener('click', () => {
                if (!audioInit) initAudio();
                if (isRunning) {
                    clearInterval(timerInterval); isRunning = false;
                    startTimerBtn.textContent = "–í–∞—Ä–∏—Ç—å!"; timerStatus.textContent = "–ó–µ–ª—å–µ –Ω–∞ –ø–∞—É–∑–µ";
                } else {
                    isRunning = true; startTimerBtn.textContent = "–ü–∞—É–∑–∞"; timerStatus.textContent = "–ó–µ–ª—å–µ –≤–∞—Ä–∏—Ç—Å—è...";
                    timerInterval = setInterval(() => {
                        timerTime--; updateDisplay();
                        if (timerTime <= 0) {
                            clearInterval(timerInterval); isRunning = false;
                            if(audioInit) window.alarmSynth.triggerAttackRelease("C5", "1s");
                            timerStatus.textContent = "–ì–æ—Ç–æ–≤–æ! –û—Ç–¥–æ—Ö–Ω–∏—Ç–µ."; startTimerBtn.textContent = "–í–∞—Ä–∏—Ç—å!";
                            timerTime = defaultTime * 60;
                            updateDisplay(); 
                            if (audioInit && brownNoise) {
                                brownNoise.volume.rampTo(-Infinity, 1);
                                const noiseBtn = document.getElementById('noiseToggleBtn');
                                if (noiseBtn) {
                                    noiseBtn.classList.remove('active');
                                    noiseBtn.style.opacity = 0.6;
                                }
                            }
                        }
                    }, 1000);
                }
            });
            document.getElementById('resetTimerBtn').addEventListener('click', () => {
                clearInterval(timerInterval); isRunning = false;
                timerTime = defaultTime * 60; updateDisplay();
                startTimerBtn.textContent = "–í–∞—Ä–∏—Ç—å!"; timerStatus.textContent = "–ö–æ—Ç–µ–ª–æ–∫ –ø—É—Å—Ç";
            });
            document.getElementById('noiseToggleBtn').addEventListener('click', function() {
                if(!audioInit) initAudio();
                if (this.classList.contains('active')) {
                    brownNoise.volume.rampTo(-Infinity, 1); this.classList.remove('active'); this.style.opacity = 0.6;
                } else {
                    brownNoise.volume.rampTo(-12, 1); this.classList.add('active'); this.style.opacity = 1;
                }
            });
            
            // --- –§–£–ù–ö–¶–ò–Ø: –û—á–∏—Å—Ç–∫–∞ –º–æ–¥–∞–ª–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            function resetAddTaskModal() {
                document.getElementById('taskInput').value = '';
                document.getElementById('taskDescriptionInput').value = '';
                datePicker.clear();
                newTaskSubtaskList.innerHTML = '<p class="text-center text-sm text-gray-600 italic">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç...</p>';
                newTaskNewSubtask.value = '';
                document.querySelector('input[name="taskCat"][value="students"]').checked = true;
                document.getElementById('taskPriority').value = 'medium';
                document.getElementById('taskAssignee').value = 'everyone';
            }

            // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–î–ê–ß–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            const datePicker = flatpickr("#taskDueDate", { locale: "ru", enableTime: true, time_24hr: true, dateFormat: "Y-m-d H:i" });
            
            openTaskModalBtn.addEventListener('click', () => { 
                resetAddTaskModal(); 
                updateAssigneeSelectors(); 
                modal.style.display = 'flex'; 
                if(!audioInit) initAudio();
            });
            closeTaskModalBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                resetAddTaskModal(); 
            });
            modal.addEventListener('click', (e) => { 
                if(e.target === modal) {
                    modal.style.display = 'none'; 
                    resetAddTaskModal(); 
                }
            });

            addTaskBtn.addEventListener('click', async () => {
                if (!currentUserId) {
                    console.error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É");
                    return;
                }
                const text = document.getElementById('taskInput').value.trim();
                if (!text) return;
                
                const taskDate = document.getElementById('taskDueDate').value;
                
                const subtasks = [];
                newTaskSubtaskList.querySelectorAll('.subtask-item').forEach(itemEl => {
                    const subtaskTextEl = itemEl.querySelector('.subtask-text');
                    if (subtaskTextEl) {
                        const subtaskText = subtaskTextEl.textContent.trim();
                        if (subtaskText) {
                            subtasks.push({ text: subtaskText, done: false });
                        }
                    }
                });

                const assigneeValue = taskAssigneeSelect.value;
                let assignedTo = { uid: 'everyone', nickname: 'Everyone' };
                if (assigneeValue === 'me') {
                    assignedTo = { uid: currentUserId, nickname: currentUserNickname };
                } else if (assigneeValue === 'partner' && otherUserInfo.uid) {
                    assignedTo = { uid: otherUserInfo.uid, nickname: otherUserInfo.nickname };
                }

                const newTask = {
                    text: text,
                    description: document.getElementById('taskDescriptionInput').value.trim() || '',
                    subtasks: subtasks, 
                    date: taskDate ? Timestamp.fromDate(new Date(taskDate)) : null,
                    priority: document.getElementById('taskPriority').value,
                    category: document.querySelector('input[name="taskCat"]:checked').value,
                    status: 'pending', 
                    createdBy: currentUserId,
                    assignedTo: assignedTo 
                };
                
                try {
                    const tasksCol = collection(db, `/artifacts/${appId}/public/data/tasks`);
                    await addDoc(tasksCol, newTask);
                    
                    resetAddTaskModal();
                    modal.style.display = 'none';
                    if(audioInit) window.addSynth.triggerAttackRelease(["C4", "E4"], "8n");
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:", e);
                }
            });
            
            // --- –°–õ–£–®–ê–¢–ï–õ–ò (–ü–æ–¥–∑–∞–¥–∞—á–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏) (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            function addNewSubtaskLocal() {
                const text = newTaskNewSubtask.value.trim();
                if (!text) return;

                if (!newTaskSubtaskList.querySelector('.subtask-item')) {
                    newTaskSubtaskList.innerHTML = '';
                }

                const el = document.createElement('div');
                el.className = 'subtask-item';
                el.innerHTML = `
                    <span class="magic-input subtask-text" style="display: block; width: 100%;">${text}</span>
                    <button class="subtask-delete-btn" type="button">&times;</button>
                `;
                newTaskSubtaskList.appendChild(el);
                newTaskNewSubtask.value = ''; 
            }

            newTaskAddSubtaskBtn.addEventListener('click', (e) => {
                e.preventDefault(); 
                addNewSubtaskLocal();
            });

            newTaskNewSubtask.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addNewSubtaskLocal();
                }
            });

            newTaskSubtaskList.addEventListener('click', (e) => {
                if (e.target.classList.contains('subtask-delete-btn')) {
                    e.target.closest('.subtask-item').remove();
                    if (!newTaskSubtaskList.querySelector('.subtask-item')) {
                        newTaskSubtaskList.innerHTML = '<p class="text-center text-sm text-gray-600 italic">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç...</p>';
                    }
                }
            });

            // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–ò–õ–¨–¢–†–û–í (–ó–∞–¥–∞—á) (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            filterActiveBtn.addEventListener('click', (e) => {
                currentFilter = 'active';
                updateFilterButtons(e.target);
                renderTasks();
            });
            filterHighBtn.addEventListener('click', (e) => {
                currentFilter = 'high';
                updateFilterButtons(e.target);
                renderTasks();
            });
            filterCompletedBtn.addEventListener('click', (e) => {
                currentFilter = 'completed';
                updateFilterButtons(e.target);
                renderTasks();
            });
            
            function updateFilterButtons(activeButton) {
                [filterActiveBtn, filterHighBtn, filterCompletedBtn].forEach(btn => {
                    btn.classList.remove('active');
                });
                if (activeButton) {
                    activeButton.classList.add('active');
                }
            }
            updateFilterButtons(filterActiveBtn); 

            hatSortBtn.addEventListener('click', () => {
                if(!audioInit) initAudio();
                const activeTasks = allTasks.filter(t => t.status === 'pending' || t.status === 'inProgress');
                if(activeTasks.length === 0) {
                    console.warn("–®–ª—è–ø–µ –Ω–µ—á–µ–≥–æ –≤—ã–±–∏—Ä–∞—Ç—å!");
                    // TODO: –ó–∞–º–µ–Ω–∏—Ç—å alert –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    // alert("üé© –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è!");
                    return;
                }
                const randomTask = activeTasks[Math.floor(Math.random() * activeTasks.length)];
                // TODO: –ó–∞–º–µ–Ω–∏—Ç—å alert –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                // alert(`üé© –®–ª—è–ø–∞ –≤—ã–±—Ä–∞–ª–∞: "${randomTask.text}"!`);
                if(audioInit) window.hatSynth.triggerAttackRelease("G4", "8n");
            });

            // --- –°–õ–£–®–ê–¢–ï–õ–ò (–ù–∞—Å—Ç—Ä–æ–π–∫–∏) (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            openSettingsBtn.addEventListener('click', () => {
                if (currentUserNickname) {
                    nicknameInput.value = currentUserNickname;
                }
                settingsModal.style.display = 'flex';
            });
            closeSettingsModalBtn.addEventListener('click', () => settingsModal.style.display = 'none');
            settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) settingsModal.style.display = 'none'; });
            
            saveNicknameBtn.addEventListener('click', async () => {
                const newNickname = nicknameInput.value.trim();
                if (!newNickname || newNickname === currentUserNickname || !currentUserId) {
                    settingsModal.style.display = 'none';
                    return;
                }

                saveNicknameBtn.disabled = true;
                saveNicknameBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUserId);
                    await updateDoc(userDocRef, { nickname: newNickname });

                    const userStatusRef = ref(rtdb, `/artifacts/${appId}/presence/${currentUserId}/name`);
                    await set(userStatusRef, newNickname);
                    
                    currentUserNickname = newNickname;
                    currentUserDisplayEl.textContent = newNickname;

                    settingsModal.style.display = 'none';
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∏–∫–Ω–µ–π–º–∞:", e);
                } finally {
                    saveNicknameBtn.disabled = false;
                    saveNicknameBtn.textContent = "‚ú® –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚ú®";
                }
            });

            // --- –°–õ–£–®–ê–¢–ï–õ–ò –ò –§–£–ù–ö–¶–ò–ò (–î–µ—Ç–∞–ª–∏ –ó–∞–¥–∞—á–∏) (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            
            detailDatePicker = flatpickr("#taskDetailDateEdit", { locale: "ru", enableTime: true, time_24hr: true, dateFormat: "Y-m-d H:i" });
            
            window.showTaskDetails = (id) => {
                currentEditingTaskId = id;
                const task = allTasks.find(t => t.id === id);
                if (!task) {
                    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–¥–∞—á—É!");
                    return;
                }
                
                populateTaskDetailView(task);
                toggleTaskDetailEdit(false); 
                renderSubtasks(task.subtasks || [], false); 
                taskDetailModal.style.display = 'flex';
            };
            
            function populateTaskDetailView(task) {
                taskDetailTitle.textContent = task.text;
                taskDetailDescriptionText.textContent = task.description || '...';
                
                const catName = catNames[task.category] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const catColor = catColors[task.category] || '#666';
                taskDetailCategory.textContent = catName;
                taskDetailCategory.style.backgroundColor = catColor;
                
                const priorities = { low: '–û–±—ã—á–Ω—ã–π', medium: '–í–∞–∂–Ω—ã–π', high: '–°—Ä–æ—á–Ω—ã–π!' };
                taskDetailPriority.textContent = priorities[task.priority] || '...';
                
                taskDetailDate.textContent = task.date 
                    ? task.date.toLocaleString('ru', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' }) 
                    : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                
                taskDetailAssignee.textContent = task.assignedTo ? task.assignedTo.nickname : '–î–ª—è –≤—Å–µ—Ö';
            }
            
            function populateTaskDetailEdit(task) {
                taskDetailTitleEdit.value = task.text;
                taskDetailDescriptionEdit.value = task.description || '';
                
                const catRadio = taskDetailCategoryEdit.querySelector(`input[value="${task.category}"]`);
                if (catRadio) catRadio.checked = true;
                
                if (task.date) {
                    detailDatePicker.setDate(task.date);
                } else {
                    detailDatePicker.clear();
                }
                
                taskDetailPriorityEdit.value = task.priority;
                
                updateAssigneeSelectors(); 
                if (!task.assignedTo || task.assignedTo.uid === 'everyone') {
                    taskDetailAssigneeEdit.value = 'everyone';
                } else if (task.assignedTo.uid === currentUserId) {
                    taskDetailAssigneeEdit.value = 'me';
                } else if (task.assignedTo.uid === otherUserInfo.uid) {
                    taskDetailAssigneeEdit.value = 'partner';
                } else {
                    taskDetailAssigneeEdit.value = 'everyone';
                }
            }

            closeTaskDetailModalBtn.addEventListener('click', () => {
                taskDetailModal.style.display = 'none';
                currentEditingTaskId = null;
                isTaskDetailEditing = false; 
            });
            taskDetailModal.addEventListener('click', (e) => { 
                if(e.target === taskDetailModal) {
                    taskDetailModal.style.display = 'none';
                    currentEditingTaskId = null;
                    isTaskDetailEditing = false; 
                }
            });

            function renderSubtasks(subtasks, isEditing) {
                const selectAllContainer = document.getElementById('subtaskSelectAllContainer');
                const selectAllCheckbox = document.getElementById('toggleAllSubtasksCheckbox');
                
                taskDetailSubtaskList.innerHTML = ''; 
                
                if (subtasks.length === 0) {
                    taskDetailSubtaskList.innerHTML = '<p class="text-center text-sm text-gray-600 italic">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç...</p>';
                    selectAllContainer.classList.add('hidden'); 
                    return;
                }
                
                selectAllContainer.classList.remove('hidden'); 
                const allDone = subtasks.every(s => s.done);
                selectAllCheckbox.checked = allDone;

                subtasks.forEach((subtask, index) => {
                    const el = document.createElement('div');
                    el.className = 'subtask-item';
                    const uniqueId = `subtask-${index}-${currentEditingTaskId}`; 
                    
                    if (isEditing) {
                        el.innerHTML = `
                            <input type="checkbox" id="${uniqueId}" ${subtask.done ? 'checked' : ''} onchange="window.toggleSubtask(${index}, this.checked)">
                            <input type="text" class="magic-input subtask-text" value="${subtask.text}">
                            <button class="subtask-delete-btn" data-index="${index}">&times;</button>
                        `;
                    } else {
                        el.innerHTML = `
                            <input type="checkbox" id="${uniqueId}" ${subtask.done ? 'checked' : ''} onchange="window.toggleSubtask(${index}, this.checked)" class="flex-shrink-0">
                            <label for="${uniqueId}" class="subtask-text flex-grow cursor-pointer p-2 ${subtask.done ? 'line-through opacity-70' : ''}">${subtask.text}</label>
                        `;
                    }
                    taskDetailSubtaskList.appendChild(el);
                });
            }
            
            window.toggleSubtask = async (subtaskIndex, isChecked) => {
                if (!currentEditingTaskId) return;
                
                const task = allTasks.find(t => t.id === currentEditingTaskId);
                if (!task) return;
                
                const newSubtasks = JSON.parse(JSON.stringify(task.subtasks || []));
                
                if (newSubtasks[subtaskIndex]) {
                    newSubtasks[subtaskIndex].done = isChecked;
                }
                
                try {
                    const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, currentEditingTaskId);
                    await updateDoc(taskRef, {
                        subtasks: newSubtasks
                    });
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–∑–∞–¥–∞—á–∏:", e);
                }
            };
            
            window.toggleAllSubtasks = async (setChecked) => {
                if (!currentEditingTaskId) return;
                const task = allTasks.find(t => t.id === currentEditingTaskId);
                if (!task || !task.subtasks) return;
                
                const newSubtasks = task.subtasks.map(sub => ({
                    ...sub,
                    done: setChecked
                }));
                
                try {
                    const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, currentEditingTaskId);
                    await updateDoc(taskRef, {
                        subtasks: newSubtasks
                    });
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–¥–∑–∞–¥–∞—á:", e);
                }
            };
            
            toggleAllSubtasksCheckbox.addEventListener('change', (e) => {
                if (!currentEditingTaskId) return;
                window.toggleAllSubtasks(e.target.checked);
            });

            taskDetailAddSubtaskBtn.addEventListener('click', () => {
                const text = taskDetailNewSubtask.value.trim();
                if (!text) return;

                if (!taskDetailSubtaskList.querySelector('.subtask-item')) {
                    taskDetailSubtaskList.innerHTML = '';
                }

                const el = document.createElement('div');
                el.className = 'subtask-item';
                el.innerHTML = `
                    <input type="checkbox">
                    <input type="text" class="magic-input subtask-text" value="${text}">
                    <button class="subtask-delete-btn">&times;</button>
                `;
                taskDetailSubtaskList.appendChild(el);
                taskDetailNewSubtask.value = ''; 
            });
            taskDetailNewSubtask.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    taskDetailAddSubtaskBtn.click();
                }
            });

            taskDetailSubtaskList.addEventListener('click', (e) => {
                if (e.target.classList.contains('subtask-delete-btn')) {
                    e.target.closest('.subtask-item').remove();
                    if (!taskDetailSubtaskList.querySelector('.subtask-item')) {
                        taskDetailSubtaskList.innerHTML = '<p class="text-center text-sm text-gray-600 italic">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç...</p>';
                    }
                }
            });

            taskDetailSaveBtn.addEventListener('click', async () => {
                if (!currentEditingTaskId) return;

                taskDetailSaveBtn.disabled = true;
                taskDetailSaveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

                const newText = taskDetailTitleEdit.value.trim();
                const newDescription = taskDetailDescriptionEdit.value.trim(); 
                const newCategory = taskDetailCategoryEdit.querySelector('input[name="taskCatDetail"]:checked')?.value || 'students';
                const newPriority = taskDetailPriorityEdit.value;
                const newDateStr = taskDetailDateEdit.value;
                
                const newSubtasks = [];
                taskDetailSubtaskList.querySelectorAll('.subtask-item').forEach(itemEl => {
                    const textInput = itemEl.querySelector('.subtask-text');
                    const text = textInput ? textInput.value.trim() : ''; 
                    const done = itemEl.querySelector('input[type="checkbox"]').checked;
                    if (text) { 
                        newSubtasks.push({ text, done });
                    }
                });
                
                const assigneeValue = taskDetailAssigneeEdit.value;
                let newAssignedTo = { uid: 'everyone', nickname: 'Everyone' };
                if (assigneeValue === 'me') {
                    newAssignedTo = { uid: currentUserId, nickname: currentUserNickname };
                } else if (assigneeValue === 'partner' && otherUserInfo.uid) {
                    newAssignedTo = { uid: otherUserInfo.uid, nickname: otherUserInfo.nickname };
                }
                
                const updates = {
                    text: newText,
                    description: newDescription,
                    category: newCategory,
                    priority: newPriority,
                    date: newDateStr ? Timestamp.fromDate(new Date(newDateStr)) : null,
                    subtasks: newSubtasks,
                    assignedTo: newAssignedTo
                };

                try {
                    const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, currentEditingTaskId);
                    await updateDoc(taskRef, updates);
                    
                    toggleTaskDetailEdit(false);
                    const updatedTask = { ...allTasks.find(t => t.id === currentEditingTaskId), ...updates, date: newDateStr ? new Date(newDateStr) : null };
                    populateTaskDetailView(updatedTask);

                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏:", e);
                } finally {
                    taskDetailSaveBtn.disabled = false;
                    taskDetailSaveBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ò–∑–º–µ–Ω–µ–Ω–∏—è";
                }
            });
            
            function toggleTaskDetailEdit(isEditing) {
                const task = allTasks.find(t => t.id === currentEditingTaskId);
                if (!task) return;

                isTaskDetailEditing = isEditing;
                
                taskDetailEditBtn.classList.toggle('hidden', isEditing);
                taskDetailSaveBtn.classList.toggle('hidden', !isEditing);
                
                taskDetailViewBlock.classList.toggle('hidden', isEditing);
                taskDetailEditBlock.classList.toggle('hidden', !isEditing);
                
                taskDetailAddSubtaskContainer.classList.toggle('hidden', !isEditing);
                
                if (isEditing) {
                    populateTaskDetailEdit(task);
                } else {
                    populateTaskDetailView(task);
                }
                
                renderSubtasks(task.subtasks || [], isEditing);
            }

            taskDetailEditBtn.addEventListener('click', () => {
                toggleTaskDetailEdit(true);
            });
            
            // --- –§–£–ù–ö–¶–ò–ò (–°—Ç–∏–∫–µ—Ä—ã) ---
            
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï iOS: –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏-—Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            function onDragStart(clientX, clientY, el) {
                isStickerDragging = true;
                currentDraggingSticker = el;
                
                stickerOffsetX = clientX - el.getBoundingClientRect().left;
                stickerOffsetY = clientY - el.getBoundingClientRect().top;
                
                el.style.cursor = 'grabbing';
                el.style.zIndex = 4001; 
            }

            function onDragMove(clientX, clientY) {
                if (!isStickerDragging || !currentDraggingSticker) return;
                
                let newX = clientX - stickerOffsetX;
                let newY = clientY - stickerOffsetY;

                const elRect = currentDraggingSticker.getBoundingClientRect();
                newX = Math.max(0, Math.min(newX, window.innerWidth - elRect.width));
                newY = Math.max(0, Math.min(newY, window.innerHeight - elRect.height));

                currentDraggingSticker.style.left = `${newX}px`;
                currentDraggingSticker.style.top = `${newY}px`;
            }
            
            function onDragEnd() {
                if (isStickerDragging && currentDraggingSticker) {
                    currentDraggingSticker.style.cursor = 'grab';
                    currentDraggingSticker.style.zIndex = ''; 
                }
                isStickerDragging = false;
                currentDraggingSticker = null;
            }
            // --- –ö–æ–Ω–µ—Ü –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π ---
            
            function addStickerToDOM(sticker) {
                const timerRect = {
                    x: window.innerWidth - 220 - 20, 
                    y: 20,
                    w: 220,
                    h: 150 
                };
                const stickerSize = { w: 200, h: 200 };

                const el = document.createElement('div');
                el.className = 'sticker-note-absolute';
                el.id = `sticker-${sticker.id}`; 
                
                let x, y, isOverlapping;
                do {
                    const xPercent = 5 + Math.random() * 80; 
                    const yPercent = 10 + Math.random() * 70; 
                    
                    x = (xPercent / 100) * window.innerWidth;
                    y = (yPercent / 100) * window.innerHeight;
                    
                    const stickerRight = x + stickerSize.w;
                    const stickerBottom = y + stickerSize.h;
                    
                    const timerRight = timerRect.x + timerRect.w;
                    const timerBottom = timerRect.y + timerRect.h;

                    isOverlapping = (
                        stickerRight > timerRect.x && 
                        x < timerRight &&           
                        stickerBottom > timerRect.y &&
                        y < timerBottom             
                    );

                } while (isOverlapping);

                el.style.left = `${x}px`;
                el.style.top = `${y}px`;
                el.style.transform = `rotate(${Math.random() * 10 - 5}deg)`; 

                el.innerHTML = `
                    <button class="sticker-delete-btn" onclick="window.deleteSticker('${sticker.id}')" title="–£–¥–∞–ª–∏—Ç—å">&times;</button>
                    <div class="sticker-text">${sticker.text}</div>
                    <span class="sticker-author">${sticker.nickname}</span>
                `;

                // –ò–ó–ú–ï–ù–ï–ù–ò–ï iOS: –ò—Å–ø–æ–ª—å–∑—É–µ–º onDragStart –¥–ª—è Mouse –∏ Touch
                el.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('sticker-delete-btn')) return;
                    e.preventDefault(); // –í–∞–∂–Ω–æ –¥–ª—è mousedown
                    onDragStart(e.clientX, e.clientY, el);
                });
                
                el.addEventListener('touchstart', (e) => {
                    if (e.target.classList.contains('sticker-delete-btn')) return;
                    // e.preventDefault() –ù–ï –Ω—É–∂–µ–Ω –¥–ª—è touchstart —Å {passive: true}
                    const touch = e.touches[0];
                    onDragStart(touch.clientX, touch.clientY, el);
                }, { passive: true }); // {passive: true} –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

                stickerBackdrop.appendChild(el);
            }

            function removeStickerFromDOM(stickerId) {
                const el = document.getElementById(`sticker-${stickerId}`);
                if (el) {
                    el.remove();
                }
            }

            function listenForStickers() {
                if (stickersUnsubscribe) stickersUnsubscribe();
                const stickersCol = collection(db, `/artifacts/${appId}/public/data/stickers`);
                
                stickersUnsubscribe = onSnapshot(stickersCol, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        const docData = change.doc.data();
                        const sticker = {
                            id: change.doc.id, 
                            ...docData, 
                            createdAt: docData.createdAt ? docData.createdAt.toDate() : new Date() 
                        };

                        if (change.type === "added") {
                            allStickers.push(sticker); 
                            if (!document.getElementById(`sticker-${sticker.id}`)) {
                                addStickerToDOM(sticker);
                            }
                        }
                        if (change.type === "removed") {
                            allStickers = allStickers.filter(s => s.id !== change.doc.id); 
                            removeStickerFromDOM(sticker.id);
                        }
                    });
                }, (error) => console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–º–µ—Ç–æ–∫:", error));
            }
            
            window.deleteSticker = async (id) => {
                if (!currentUserId) return;
                
                const stickerRef = doc(db, `/artifacts/${appId}/public/data/stickers`, id);
                try {
                    await deleteDoc(stickerRef);
                } catch (e) { console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–º–µ—Ç–∫–∏:", e); }
            };

            addStickerBtn.addEventListener('click', async () => {
                const text = newStickerText.value.trim();
                if (!text || !currentUserId || !currentUserNickname) return;
                
                addStickerBtn.disabled = true;
                const newSticker = {
                    text: text,
                    createdBy: currentUserId,
                    nickname: currentUserNickname,
                    createdAt: Timestamp.now()
                };
                
                try {
                    const stickersCol = collection(db, `/artifacts/${appId}/public/data/stickers`);
                    await addDoc(stickersCol, newSticker);
                    newStickerText.value = '';
                    stickerModal.style.display = 'none'; 
                } catch (e) { console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–º–µ—Ç–∫–∏:", e); }
                finally { addStickerBtn.disabled = false; }
            });
            
            openStickerModalBtn.addEventListener('click', () => stickerModal.style.display = 'flex');
            closeStickerModalBtn.addEventListener('click', () => stickerModal.style.display = 'none');
            stickerModal.addEventListener('click', (e) => { if(e.target === stickerModal) stickerModal.style.display = 'none'; });
            
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï iOS: –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (Mouse + Touch)
            document.addEventListener('mousemove', (e) => {
                if (!isStickerDragging) return;
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
                onDragMove(e.clientX, e.clientY);
            });
            document.addEventListener('mouseup', onDragEnd);
            
            document.addEventListener('touchmove', (e) => {
                if (!isStickerDragging) return;
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const touch = e.touches[0];
                onDragMove(touch.clientX, touch.clientY);
            }, { passive: false }); // passive: false, —Ç–∞–∫ –∫–∞–∫ –º—ã –≤—ã–∑—ã–≤–∞–µ–º preventDefault
            
            document.addEventListener('touchend', onDragEnd);
            document.addEventListener('touchcancel', onDragEnd); // –ù–∞ —Å–ª—É—á–∞–π –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è

        });
    </script>
</body>
</html>