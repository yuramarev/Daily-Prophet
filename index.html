<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–æ–ª—à–µ–±–Ω—ã–π –ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ (–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–π)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/flatpickr.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
    
    <!-- 
      –ò–ú–ü–û–†–¢ –ò –ù–ê–°–¢–†–û–ô–ö–ê FIREBASE
      –¢–≤–æ–π –∫–æ–Ω—Ñ–∏–≥ –≤—Å—Ç—Ä–æ–µ–Ω –Ω–∞–ø—Ä—è–º—É—é.
    -->
    <script type="module">
        // --- –¢–í–û–ô –ö–û–ù–§–ò–ì FIREBASE (–≤—Å—Ç—Ä–æ–µ–Ω –Ω–∞–ø—Ä—è–º—É—é) ---
        // –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∫–æ–Ω—Ñ–∏–≥ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
        const firebaseConfig = {
          apiKey: "AIzaSyDYGKiBAEtfp3DKAX4PDR2OymJ3YJlfMXg",
          authDomain: "magic-diary-1a1cf.firebaseapp.com",
          projectId: "magic-diary-1a1cf",
          storageBucket: "magic-diary-1a1cf.firebasestorage.app",
          messagingSenderId: "362532075783",
          appId: "1:362532075783:web:d5e0ce019c031852afada2"
        };
        // ----------------------------------------------------
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'appId' –∏–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è –ø—É—Ç–µ–π –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        const appId = firebaseConfig.appId;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        try {
            const { initializeApp, setLogLevel } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            // –î–û–ë–ê–í–õ–ï–ù–´ –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò
            const { 
                getAuth, 
                signInAnonymously, 
                signInWithCustomToken, 
                onAuthStateChanged,
                createUserWithEmailAndPassword, 
                signInWithEmailAndPassword,     
                signOut                         
            } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            
            // –ù–û–í–û–ï: getDoc –∏ setDoc –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, Timestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            const { getDatabase, ref, set, onValue, onDisconnect } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js");

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const rtdb = getDatabase(app);
            
            // –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            setLogLevel('debug');

            // –ü–µ—Ä–µ–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å, —á—Ç–æ–±—ã DOMContentLoaded –º–æ–≥ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
            window.firebaseServices = {
                auth, db, rtdb, appId,
                signInAnonymously, onAuthStateChanged,
                createUserWithEmailAndPassword, 
                signInWithEmailAndPassword,     
                signOut,                        
                doc, getDoc, setDoc, // <-- –ù–û–í–´–ï
                addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, Timestamp, // <-- –î–æ–±–∞–≤–ª–µ–Ω query –∏ where
                ref, set, onValue, onDisconnect
            };
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", e);
            document.body.innerHTML = '<div class="text-white p-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ `firebaseConfig`.</div>';
        }
    </script>
    
    <style>
        :root {
            --cat-students: #3b82f6; --cat-home: #d97706; --cat-projects: #9333ea;
            --cat-hobbies: #10b981; --cat-love: #ec4899; --cat-shop: #eab308; --cat-docs: #64748b;
        }
        body {
            font-family: 'Merriweather', serif; background-color: #1a1a2e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-denim.png');
            overflow-x: hidden;
        }
        .magic-parchment {
            background-color: rgba(250, 245, 230, 0.95); border: 4px solid #4a2c2a;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 15px rgba(74, 44, 42, 0.5) inset;
        }
        h1.magic-title { font-family: 'Cinzel Decorative', serif; text-shadow: 1px 1px 2px rgba(199, 162, 101, 0.7); }

        /* --- –°–¢–ò–õ–ò –¢–ê–ô–ú–ï–†–ê --- */
        #stickyTimer { position: fixed; top: 1rem; right: 1rem; z-index: 1000; width: 220px; transition: transform 0.3s ease; }
        .timer-display-compact { font-family: 'Cinzel Decorative', serif; font-size: 1.8rem; font-weight: 700; color: #4a2c2a; text-align: center; line-height: 1; cursor: pointer; }
        .btn-timer-small { font-size: 0.8rem; padding: 4px 8px; background-color: #4a2c2a; color: #fdf5e6; border: 1px solid #c7a265; border-radius: 4px; cursor: pointer; }
        .btn-timer-small:hover { background-color: #6d413c; }
        .btn-icon-small { background: none; border: none; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; font-size: 1.1rem; }
        .btn-icon-small:hover, .btn-icon-small.active { opacity: 1; }

        /* --- –ö–ê–¢–ï–ì–û–†–ò–ò --- */
        .category-pill { display: inline-block; cursor: pointer; font-size: 0.85rem; font-weight: bold; padding: 0.25rem 0.75rem; border-radius: 9999px; color: white; border: 2px solid transparent; transition: all 0.2s; opacity: 0.7; }
        .category-pill:hover { opacity: 1; transform: translateY(-1px); }
        .category-pill input { display: none; }
        .category-pill:has(input:checked) { opacity: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border-color: #4a2c2a; transform: scale(1.05); }
        .cat-students { background-color: var(--cat-students); } .cat-home { background-color: var(--cat-home); }
        .cat-projects { background-color: var(--cat-projects); } .cat-hobbies { background-color: var(--cat-hobbies); }
        .cat-love { background-color: var(--cat-love); } .cat-shop { background-color: var(--cat-shop); }
        .cat-docs { background-color: var(--cat-docs); }
        .task-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; margin-right: 0.5rem; display: inline-block; vertical-align: middle; }

        /* --- –ö–ê–õ–ï–ù–î–ê–†–¨ (–û–±–Ω–æ–≤–ª–µ–Ω–æ) --- */
        #calendarViewContainer { display: none; min-height: 500px; }
        .fc { font-family: 'Merriweather', serif; color: #4a2c2a; }
        .fc-toolbar-title { font-family: 'Cinzel Decorative', serif !important; }
        .fc-button-primary { background-color: #4a2c2a !important; border-color: #c7a265 !important; font-family: 'Merriweather', serif; font-weight: bold; }
        
        /* –ù–û–í–û–ï: –ë–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è */
        .fc-day-today { 
            background-color: rgba(199, 162, 101, 0.2) !important; 
            border: 2px solid #4a2c2a !important; /* –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–∞–º–∫–∞ */
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ —Å–æ–±—ã—Ç–∏–π –≤ –º–µ—Å—è—á–Ω–æ–º –≤–∏–¥–µ */
        .fc-daygrid-month-view .fc-daygrid-event {
            display: none;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —è—á–µ–π–∫–∏ */
        .fc-daygrid-day-frame { cursor: pointer; position: relative; } 
        .fc-daygrid-day-frame:hover { background-color: rgba(199, 162, 101, 0.1); }
        .fc-daygrid-day-number { position: relative; z-index: 1; padding-left: 5px; padding-top: 2px; } /* –ù–æ–º–µ—Ä –¥–Ω—è –ø–æ–≤–µ—Ä—Ö */
        .day-task-count {
            position: absolute;
            bottom: 4px;
            right: 4px;
            z-index: 0;
            font-size: 0.9rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: rgba(74, 44, 42, 0.7);
            color: white;
            line-height: 1.2;
        }
        .day-task-count-completed {
            background-color: rgba(22, 163, 74, 0.8); /* –ó–µ–ª–µ–Ω—ã–π */
        }
        .day-task-count-mixed {
            background-color: rgba(217, 119, 6, 0.8); /* –û—Ä–∞–Ω–∂–µ–≤—ã–π */
        }


        /* --- –û–ë–©–ò–ï –≠–õ–ï–ú–ï–ù–¢–´ --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { width: 100%; max-width: 42rem; max-height: 90vh; overflow-y: auto; }
        .btn-magic { font-family: 'Merriweather', serif; font-weight: 700; background-color: #4a2c2a; color: #fdf5e6; border: 2px solid #c7a265; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.2s ease; cursor: pointer; }
        .btn-magic:hover { background-color: #6d413c; color: #fff; transform: translateY(-2px); }
        /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π input */
        .magic-input {
            width: 100%; padding: 0.75rem; border-radius: 6px; border: 2px solid #c7a265;
            background-color: #fff; color: #4a2c2a;
            font-family: 'Merriweather', serif; font-size: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) inset;
            transition: all 0.2s;
        }
        .magic-input:focus {
            outline: none; border-color: #4a2c2a; background-color: #fff;
            box-shadow: 0 0 10px rgba(199, 162, 101, 0.5);
        }

        /* --- –°–¢–ò–õ–ò –ó–ê–î–ê–ß (–æ–±–Ω–æ–≤–ª–µ–Ω–æ) --- */
        .task-item { animation: fadeIn 0.4s ease-out; border-left-width: 8px; transition: all 0.3s ease; }
        .task-item.status-completed { opacity: 0.6; filter: grayscale(50%); text-decoration: line-through; }
        .task-item.status-inProgress { background-color: #fffbeb !important; border-left-color: var(--cat-projects); }
        .task-item.priority-high { border-left-color: #e53e3e; }
        .task-item.priority-medium { border-left-color: #f6e05e; }
        .task-item.priority-low { border-left-color: #a0aec0; }
        .task-spell-btn {
            font-size: 0.9rem; padding: 3px 8px; border-radius: 4px; transition: all 0.2s;
            font-family: monospace; font-weight: bold; border: 1px solid;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –í–ò–î–û–í (–§–∏–ª—å—Ç—Ä—ã) --- */
        .view-toggle { display: flex; background: rgba(255,255,255,0.3); border-radius: 8px; p-1; margin-bottom: 1rem; border: 1px solid #c7a265; }
        .view-btn { flex: 1; text-align: center; padding: 0.5rem; cursor: pointer; font-weight: bold; color: #6d413c; transition: all 0.2s; border-radius: 6px; }
        .view-btn.active { background-color: #4a2c2a; color: #fdf5e6; }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò (–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ) --- */
        .presence-indicator { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: background-color 0.3s; }
        .presence-online { background-color: #22c55e; }
        .presence-offline { background-color: #9ca3af; }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò (–≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞) --- */
        #authOverlay {
            position: fixed; inset: 0; z-index: 3000;
            display: flex; align-items: center; justify-content: center;
            background-color: #1a1a2e;
            background-image: url('https://www.transparenttextures.com/patterns/dark-denim.png');
            transition: opacity 0.3s ease;
        }
        .auth-tabs {
            display: flex; border-bottom: 2px solid #4a2c2a; margin-bottom: 1.5rem;
        }
        .auth-tab {
            flex: 1; text-align: center; padding: 0.75rem 1rem;
            font-family: 'Cinzel Decorative', serif; font-weight: 700;
            color: #6d413c; cursor: pointer;
            border-bottom: 3px solid transparent; transform: translateY(2px);
            transition: all 0.2s;
        }
        .auth-tab.active {
            color: #4a2c2a;
            border-bottom-color: #c7a265;
        }
        
        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò (–ü–æ–¥–∑–∞–¥–∞—á–∏) --- */
        .subtask-item { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .subtask-item input[type="checkbox"] { width: 1.25rem; height: 1.25rem; flex-shrink: 0; }
        .subtask-text { flex-grow: 1; padding: 0.5rem; font-size: 0.9rem; border-radius: 4px; border: 1px solid #c7a265; background: #fff; transition: all 0.2s; }
        /* –ù–û–í–û–ï: –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è */
        .subtask-item input[type="checkbox"]:checked + .subtask-text { text-decoration: line-through; opacity: 0.7; }
        .subtask-delete-btn {
            background-color: #ef4444; color: white; border: none;
            width: 1.5rem; height: 1.5rem; border-radius: 9999px;
            font-weight: bold; cursor: pointer; opacity: 0.7;
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
        }
        .subtask-delete-btn:hover { opacity: 1; }
        .hidden { display: none; }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò (–°—Ç–∏–∫–µ—Ä—ã / –ö—É–±–∞—Ä–∏–∫–∏) --- */
        #stickerBackdrop {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10;
            pointer-events: none; /* –ù–µ –º–µ—à–∞–µ—Ç –∫–ª–∏–∫–∞—Ç—å —Å–∫–≤–æ–∑—å —Å–µ–±—è */
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8) rotate(-10deg); }
            to { opacity: 1; transform: scale(1); }
        }
        .sticker-note-absolute {
            position: absolute;
            width: 200px;
            height: 200px;
            padding: 1rem;
            padding-top: 2rem;
            color: #4a2c2a;
            font-family: 'Merriweather', serif;
            animation: popIn 0.4s ease-out;
            pointer-events: auto; /* –ú–æ–∂–Ω–æ –∫–ª–∏–∫–∞—Ç—å –Ω–∞ —Å—Ç–∏–∫–µ—Ä */
            /* –ò—Å–ø–æ–ª—å–∑—É–µ–º background-image –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Å—Ç–∏–∫–µ—Ä–∞.
              –¢—ã –º–æ–∂–µ—à—å –∑–∞–º–µ–Ω–∏—Ç—å 'placehold.co' –Ω–∞ —Å–≤–æ—é PNG –∫–∞—Ä—Ç–∏–Ω–∫—É.
            */
            background-image: url('https://placehold.co/200x200/fef08a/4a2c2a.png?text=');
            background-size: contain;
            background-repeat: no-repeat;
            filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.3));
        }
        
        .sticker-delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #ef4444;
            color: white;
            width: 1.25rem; height: 1.25rem;
            border-radius: 50%;
            border: none; cursor: pointer;
            opacity: 0.3;
            font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.2s;
        }
        .sticker-note-absolute:hover .sticker-delete-btn { opacity: 1; }
        .sticker-text {
            width: 100%;
            height: 100%;
            font-size: 0.9rem;
            overflow-y: auto;
            whitespace-pre-wrap;
            word-wrap: break-word;
        }
        .sticker-author {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            opacity: 0.6;
        }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò (–ù–∞–≤–∏–≥–∞—Ü–∏—è) --- */
        .magic-nav {
            display: flex;
            background-color: rgba(74, 44, 42, 0.5); /* 4a2c2a —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
            border-radius: 8px;
            border: 2px solid #c7a265;
            margin-bottom: 1.5rem;
            padding: 0.5rem;
            gap: 0.5rem;
        }
        .nav-btn {
            flex: 1;
            text-align: center;
            padding: 0.75rem 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cinzel Decorative', serif;
            font-weight: 700;
            color: #fdf5e6;
            opacity: 0.7;
            transition: all 0.2s ease;
        }
        .nav-btn:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .nav-btn.active {
            opacity: 1;
            background-color: #4a2c2a;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            color: #fef08a; /* –ñ–µ–ª—Ç—ã–π */
        }
        .view-container {
            animation: fadeIn 0.3s ease-out;
            position: relative; /* –î–ª—è z-index */
            z-index: 20; /* –í—ã—à–µ —á–µ–º #stickerBackdrop */
        }

    </style>
</head>
<body class="p-4">

    <!-- 
      –ù–û–í–´–ô –ë–õ–û–ö: –≠–ö–†–ê–ù –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò
      –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–æ—à–µ–ª.
    -->
    <div id="authOverlay">
        <div class="magic-parchment p-6 md:p-8 w-full max-w-md mx-4">
            <h1 class="magic-title text-3xl font-bold text-yellow-900 text-center mb-6">–í–æ–ª—à–µ–±–Ω—ã–π –ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫</h1>
            
            <div class="auth-tabs">
                <div id="authTabLogin" class="auth-tab active">–í—Ö–æ–¥</div>
                <div id="authTabRegister" class="auth-tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>

            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" class="magic-input" placeholder="–í–æ–ª—à–µ–±–Ω—ã–π email..." required>
                <input type="password" id="loginPassword" class="magic-input" placeholder="–¢–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ (–ø–∞—Ä–æ–ª—å)..." required>
                <button id="loginBtn" type="submit" class="btn-magic w-full py-3 text-lg rounded-lg mt-2">–í–æ–π—Ç–∏ –≤ –ø–æ—Ä—Ç–∞–ª</button>
            </form>

            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ –ù–∏–∫–Ω–µ–π–º) -->
            <form id="registerForm" class="space-y-4" style="display: none;">
                <input type="text" id="registerNickname" class="magic-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º..." required>
                <input type="email" id="registerEmail" class="magic-input" placeholder="–í–∞—à –Ω–æ–≤—ã–π email..." required>
                <input type="password" id="registerPassword" class="magic-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å..." required>
                <input type="password" id="registerConfirmPassword" class="magic-input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å..." required>
                <button id="registerBtn" type="submit" class="btn-magic w-full py-3 text-lg rounded-lg mt-2">–°–æ–∑–¥–∞—Ç—å —Å–≤–∏—Ç–æ–∫</button>
            </form>

            <div id="authError" class="text-center text-red-600 font-bold mt-4 h-6"></div>
        </div>
    </div>


    <!-- 
      –ù–û–í–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –°–¢–ò–ö–ï–†–û–í
      (–ù–∞—Ö–æ–¥–∏—Ç—Å—è –∑–∞ –æ—Å–Ω–æ–≤–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º)
    -->
    <div id="stickerBackdrop"></div>
    
    <!-- 
      –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
      –≠—Ç–æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–∫—Ä—ã—Ç, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–æ—à–µ–ª.
      –û–Ω –∏–º–µ–µ—Ç z-index, —á—Ç–æ–±—ã –±—ã—Ç—å –ù–ê–î —Å—Ç–∏–∫–µ—Ä–∞–º–∏.
    -->
    <div id="mainAppContainer" class="max-w-4xl mx-auto mt-8 md:mt-0 px-4 relative z-20" style="display: none;">

        <!-- –¢–∞–π–º–µ—Ä (–æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ, z-index 1000) -->
        <div id="stickyTimer" class="magic-parchment p-3 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-yellow-900 uppercase tracking-widest">–ó–µ–ª—å–µ –§–æ–∫—É—Å–∞</span>
                <div class="flex gap-2">
                    <button id="timerSettingsBtn" class="btn-icon-small" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä–µ–º—è">‚öôÔ∏è</button>
                    <button id="noiseToggleBtn" class="btn-icon-small" title="–®—É–º –í—ã—Ä—É—á–∞–π-–∫–æ–º–Ω–∞—Ç—ã">üéß</button>
                </div>
            </div>
            <div id="timerDisplayContainer" class="relative">
                <div id="timerDisplay" class="timer-display-compact">25:00</div>
                <input type="number" id="timerInput" class="magic-input absolute inset-0 w-full text-center text-2xl hidden" value="25" min="1" max="180">
            </div>
            <div id="timerStatus" class="text-center text-xs text-gray-600 h-4 truncate mb-2">–ö–æ—Ç–µ–ª–æ–∫ –æ—Å—Ç—ã–ª</div>
            <div class="flex gap-2 justify-center">
                <button id="startTimerBtn" class="btn-timer-small flex-grow">–í–∞—Ä–∏—Ç—å!</button>
                <button id="resetTimerBtn" class="btn-timer-small" title="–°–±—Ä–æ—Å–∏—Ç—å">‚Üª</button>
            </div>
        </div>

        <!-- 
          –ù–û–í–´–ô –†–ï–î–ò–ó–ê–ô–ù: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ù–∞–≤–∏–≥–∞—Ü–∏—è
        -->
        
        <header class="text-center mb-6 relative pt-4">
            <h1 class="magic-title text-4xl md:text-5xl font-bold text-yellow-100">–í–æ–ª—à–µ–±–Ω—ã–π –ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫</h1>
            
            <!-- –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–ï–†–ï–ú–ï–©–ï–ù–´ –°–Æ–î–ê -->
            <div id="userControls" class="absolute top-0 right-0 p-2 flex gap-2">
                 <button id="openSettingsBtn" class="btn-timer-small" style="background-color: #3b82f6; color: white;" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
                 <button id="logoutBtn" class="btn-timer-small" style="background-color: #9333ea; color: white;" title="–í—ã–π—Ç–∏">–í—ã–π—Ç–∏ üö™</button>
            </div>
        </header>

        <!-- –ù–û–í–ê–Ø –ì–õ–ê–í–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
        <nav class="magic-nav">
            <button id="nav-tasks" class="nav-btn active">üìú –ó–∞–¥–∞—á–∏</button>
            <button id="nav-calendar" class="nav-btn">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
            <!-- –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Ç–µ–ø–µ—Ä—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É -->
            <button id="openStickerModalBtn" class="nav-btn">üìå –ù–æ–≤–∞—è –ü–æ–º–µ—Ç–∫–∞</button>
        </nav>

        <!-- 
          –ù–û–í–´–ô –†–ï–î–ò–ó–ê–ô–ù: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã-–í—å—é—à–∫–∏
          –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≤—å—é—à–∫–∞ –∑–∞ —Ä–∞–∑.
        -->

        <!-- –í–¨–Æ–®–ö–ê: –ó–∞–¥–∞—á–∏ -->
        <div id="tasksView" class="view-container">
            <div class="flex justify-center mb-6">
                <button id="openTaskModalBtn" class="btn-magic py-3 px-8 rounded-lg text-xl shadow-lg transform hover:scale-105 transition-transform">
                    ‚ú® –°–æ—Ç–≤–æ—Ä–∏—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ ‚ú®
                </button>
            </div>
            
            <main class="magic-parchment p-4 md:p-6">
                 
                 <!-- –ë–õ–û–ö –°–¢–ê–¢–£–°–ê –ü–ï–†–ï–ú–ï–©–ï–ù –°–Æ–î–ê -->
                 <div id="presenceContainer" class="mb-4 p-3 bg-yellow-50 bg-opacity-50 rounded-lg border border-yellow-800 border-opacity-30">
                    <h3 class="text-sm font-bold text-yellow-900 mb-2 text-center uppercase tracking-wider">–ü–∞–ª–∞—Ç–∞ –°–≤—è–∑–µ–π</h3>
                    <div class="flex flex-wrap justify-around items-center gap-4">
                        <div id="currentUserStatus" class="text-center">
                            <span id="currentUserDisplay" class="font-bold text-gray-800 text-sm truncate">...</span>
                            <div class="flex items-center justify-center gap-2 mt-1">
                                <div id="currentUserIndicator" class="presence-indicator presence-offline"></div>
                            </div>
                        </div>
                        <div id="otherUserStatus" class="text-center">
                            <span class="font-bold text-gray-800">–ü–∞—Ä—Ç–Ω—ë—Ä:</span>
                            <div class="flex items-center justify-center gap-2 mt-1">
                                <div id="otherUserIndicator" class="presence-indicator presence-offline"></div>
                                <span id="otherUserName" class="text-sm font-bold text-gray-600">–û—Ñ—Ñ–ª–∞–π–Ω</span>
                            </div>
                        </div>
                    </div>
                </div>
                 
                 <!-- –§–ò–õ–¨–¢–†–´ –ó–ê–î–ê–ß (–û–±–Ω–æ–≤–ª–µ–Ω–æ) -->
                 <div class="view-toggle">
                    <button id="filterActive" class="view-btn active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                    <button id="filterHigh" class="view-btn">–°—Ä–æ—á–Ω—ã–µ</button>
                    <button id="filterCompleted" class="view-btn">–ê—Ä—Ö–∏–≤</button>
                 </div>

                 <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–∞–¥–∞—á (–û–±–Ω–æ–≤–ª–µ–Ω–æ) -->
                 <div id="taskListContainer" class="mt-4">
                    <div class="mb-4 flex justify-center">
                         <button id="hatSortBtn" class="btn-timer-small opacity-100 px-3 py-2" style="background-color: #4a2c2a;">üé© –®–ª—è–ø–∞!</button>
                    </div>
                    <div id="taskList" class="space-y-3 min-h-[100px]">
                        <p class="text-center text-gray-500 italic">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π...</p>
                    </div>
                 </div>
            </main>
        </div>

        <!-- –í–¨–Æ–®–ö–ê: –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
        <div id="calendarView" class="view-container hidden">
            <div class="magic-parchment p-4 md:p-6">
                <div id='calendar'></div>
            </div>
        </div>

        <!-- –í–¨–Æ–®–ö–ê: –ü–æ–º–µ—Ç–∫–∏ (–£–î–ê–õ–ï–ù–ê) -->
        <!-- –í–¨–Æ–®–ö–ê: –ü–∞–ª–∞—Ç–∞ –°–≤—è–∑–µ–π (–£–î–ê–õ–ï–ù–ê) -->

    </div> <!-- –ö–æ–Ω–µ—Ü #mainAppContainer -->


    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div id="addTaskModal" class="modal-overlay">
        <div class="magic-parchment modal-content p-6 relative">
            <button id="closeTaskModalBtn" class="absolute top-2 right-2 text-2xl text-yellow-900 hover:text-yellow-600">&times;</button>
            <h3 class="text-2xl font-bold text-yellow-900 text-center magic-title mb-4">–ù–æ–≤–æ–µ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ</h3>
            
            <div class="space-y-4">
                <input type="text" id="taskInput" class="magic-input w-full text-lg" placeholder="–¢–µ–∫—Å—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è...">
                <textarea id="taskDescriptionInput" class="magic-input w-full" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏... (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>

                <div>
                    <label class="block text-sm font-bold text-yellow-900 mb-2">–ú–∞–≥–∏—á–µ—Å–∫–∞—è –º–µ—Ç–∫–∞:</label>
                    <div class="flex flex-wrap gap-2">
                        <label class="category-pill cat-students"><input type="radio" name="taskCat" value="students" checked> –°—Ç—É–¥–µ–Ω—Ç—ã</label>
                        <label class="category-pill cat-home"><input type="radio" name="taskCat" value="home"> –î–æ–º</label>
                        <label class="category-pill cat-projects"><input type="radio" name="taskCat" value="projects"> –ü—Ä–æ–µ–∫—Ç—ã</label>
                        <label class="category-pill cat-hobbies"><input type="radio" name="taskCat" value="hobbies"> –•–æ–±–±–∏</label>
                        <label class="category-pill cat-love"><input type="radio" name="taskCat" value="love"> –õ—é–±–æ–≤—å</label>
                        <label class="category-pill cat-shop"><input type="radio" name="taskCat" value="shop"> –ú–∞–≥–∞–∑–∏–Ω</label>
                        <label class="category-pill cat-docs"><input type="radio" name="taskCat" value="docs"> –î–æ–∫—É–º–µ–Ω—Ç—ã</label>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input id="taskDueDate" class="magic-input" placeholder="–°—Ä–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è...">
                    <select id="taskPriority" class="magic-input">
                        <option value="low">–û–±—ã—á–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                        <option value="medium" selected>–í–∞–∂–Ω—ã–π (Expelliarmus)</option>
                        <option value="high">–°—Ä–æ—á–Ω—ã–π! (–ù–µ–ø—Ä–µ–ª–æ–∂–Ω—ã–π)</option>
                    </select>
                </div>
                <button id="addTaskBtn" class="btn-magic w-full py-3 text-lg rounded-lg mt-2">‚ö° –ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏! ‚ö°</button>
            </div>
        </div>
    </div>
    
    <!-- –ù–û–í–û–ï: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –°—Ç–∏–∫–µ—Ä–∞ -->
    <div id="stickerModal" class="modal-overlay">
        <div class="magic-parchment modal-content p-6 relative max-w-md">
            <button id="closeStickerModalBtn" class="absolute top-2 right-2 text-2xl text-yellow-900 hover:text-yellow-600">&times;</button>
            <h3 class="text-2xl font-bold text-yellow-900 text-center magic-title mb-4">–ù–æ–≤–∞—è –ü–æ–º–µ—Ç–∫–∞</h3>
            <div class="space-y-4">
               <textarea id="newStickerText" class="magic-input w-full text-sm" rows="5" placeholder="–¢–µ–∫—Å—Ç –ø–æ–º–µ—Ç–∫–∏..."></textarea>
               <button id="addStickerBtn" class="btn-magic w-full py-2 text-lg mt-2">–ü—Ä–∏–∫–ª–µ–∏—Ç—å üìå</button>
            </div>
        </div>
    </div>


    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–Ω—è -->
    <div id="dayViewModal" class="modal-overlay">
        <div class="magic-parchment modal-content p-6 relative">
            <button id="closeDayViewModalBtn" class="absolute top-2 right-2 text-2xl text-yellow-900 hover:text-yellow-600">&times;</button>
            <h3 id="dayViewTitle" class="text-2xl font-bold text-yellow-900 text-center magic-title mb-4">–ü–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å</h3>
            <div id="dayViewTaskList" class="space-y-3 max-h-[70vh] overflow-y-auto">
                <!-- –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ù–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settingsModal" class="modal-overlay">
        <div class="magic-parchment modal-content p-6 relative max-w-md">
            <button id="closeSettingsModalBtn" class="absolute top-2 right-2 text-2xl text-yellow-900 hover:text-yellow-600">&times;</button>
            <h3 class="text-2xl font-bold text-yellow-900 text-center magic-title mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –í–æ–ª—à–µ–±–Ω–∏–∫–∞</h3>
            <div class="space-y-4">
                <div>
                    <label for="nicknameInput" class="block text-sm font-bold text-yellow-900 mb-2">–í–∞—à –ù–∏–∫–Ω–µ–π–º:</label>
                    <input type="text" id="nicknameInput" class="magic-input w-full text-lg">
                </div>
                <button id="saveNicknameBtn" class="btn-magic w-full py-3 text-lg rounded-lg mt-2">‚ú® –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚ú®</button>
                <hr>
                <div class="text-center text-xs text-gray-600">
                    <span class="font-bold">–í–∞—à ID –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:</span>
                    <strong id="fullCurrentUserIdSettings" class="font-mono cursor-pointer block text-sm" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">...</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –î–µ—Ç–∞–ª–µ–π –ó–∞–¥–∞—á–∏ -->
    <div id="taskDetailModal" class="modal-overlay">
        <div class="magic-parchment modal-content p-6 relative">
            <!-- –ö–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" -->
            <button id="taskDetailEditBtn" class="absolute top-4 right-16 text-2xl text-yellow-900 hover:text-yellow-600" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            
            <button id="closeTaskDetailModalBtn" class="absolute top-2 right-2 text-2xl text-yellow-900 hover:text-yellow-600">&times;</button>
            <h3 id="taskDetailTitle" class="text-2xl font-bold text-yellow-900 text-center magic-title mb-4">–î–µ—Ç–∞–ª–∏ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</h3>
            
            <div class="space-y-4">
                <div>
                    <label for="taskDetailDescription" class="block text-sm font-bold text-yellow-900 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (p) -->
                    <p id="taskDetailDescriptionText" class="text-gray-800 p-3 bg-white bg-opacity-60 rounded-lg min-h-[50px] whitespace-pre-wrap"></p>
                    <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (textarea) -->
                    <textarea id="taskDetailDescriptionEdit" class="magic-input w-full hidden" rows="4" placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-yellow-900 mb-2">–ü–æ–¥–∑–∞–¥–∞—á–∏ (—Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫):</label>
                    <div id="taskDetailSubtaskList" class="space-y-2 p-3 bg-white bg-opacity-60 rounded-lg max-h-40 overflow-y-auto">
                        <!-- –ü–æ–¥–∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div id="taskDetailAddSubtaskContainer" class="flex gap-2 mt-2 hidden">
                        <input type="text" id="taskDetailNewSubtask" class="magic-input flex-grow" placeholder="–ù–æ–≤—ã–π –ø—É–Ω–∫—Ç...">
                        <button id="taskDetailAddSubtaskBtn" class="btn-magic px-4 rounded-lg">+</button>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <button id="taskDetailSaveBtn" class="btn-magic w-full py-3 text-lg rounded-lg mt-2 hidden">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ò–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
    </div>

    <script src="https://npmcdn.com/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- –°–ï–†–í–ò–°–´ FIREBASE ---
            // –û–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ SDK –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –∏ window.firebaseServices —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω
            while (typeof window.firebaseServices === 'undefined') {
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            const {
                auth, db, rtdb, appId,
                onAuthStateChanged,
                createUserWithEmailAndPassword, 
                signInWithEmailAndPassword,     
                signOut,                        
                doc, getDoc, setDoc, 
                addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, Timestamp,
                ref, set, onValue, onDisconnect
            } = window.firebaseServices;

            // --- –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ---
            let allTasks = []; // –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –≤—Å–µ—Ö –∑–∞–¥–∞—á –∏–∑ Firestore
            let allStickers = []; // <-- –ù–û–í–û–ï
            let calendar; // –≠–∫–∑–µ–º–ø–ª—è—Ä FullCalendar
            let currentUserId = null;
            let currentUserNickname = null; 
            let currentFilter = 'active'; // 'active', 'high', 'completed'
            let tasksUnsubscribe = null; // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç onSnapshot
            let stickersUnsubscribe = null; // <-- –ù–û–í–û–ï
            let presenceUnsubscribe = null; // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç onValue
            let isAppInitialized = false; // –§–ª–∞–≥, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Å–ª—É—à–∞—Ç–µ–ª–∏) –∑–∞–ø—É—â–µ–Ω–æ
            let currentEditingTaskId = null; // ID –∑–∞–¥–∞—á–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –¥–µ—Ç–∞–ª–µ–π
            let isTaskDetailEditing = false; // –§–ª–∞–≥ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

            // --- DOM –≠–õ–ï–ú–ï–ù–¢–´ ---
            // –≠–∫—Ä–∞–Ω—ã
            const authOverlay = document.getElementById('authOverlay');
            const mainAppContainer = document.getElementById('mainAppContainer');
            // –§–æ—Ä–º—ã
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const authTabLogin = document.getElementById('authTabLogin');
            const authTabRegister = document.getElementById('authTabRegister');
            const authError = document.getElementById('authError');
            // –ö–Ω–æ–ø–∫–∏
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const openTaskModalBtn = document.getElementById('openTaskModalBtn');
            // –°–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á
            const taskListEl = document.getElementById('taskList');
            // –ú–æ–¥–∞–ª–∫–∏
            const modal = document.getElementById('addTaskModal');
            const dayViewModal = document.getElementById('dayViewModal');
            // –°—Ç–∞—Ç—É—Å
            const currentUserDisplayEl = document.getElementById('currentUserDisplay'); 
            const currentUserIndicatorEl = document.getElementById('currentUserIndicator'); 
            
            // --- –ù–û–í–´–ï DOM –≠–õ–ï–ú–ï–ù–¢–´ (–ù–∞—Å—Ç—Ä–æ–π–∫–∏) ---
            const settingsModal = document.getElementById('settingsModal');
            const openSettingsBtn = document.getElementById('openSettingsBtn');
            const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
            const nicknameInput = document.getElementById('nicknameInput');
            const saveNicknameBtn = document.getElementById('saveNicknameBtn');
            const fullCurrentUserIdSettings = document.getElementById('fullCurrentUserIdSettings'); // <-- –ù–û–í–û–ï (–≤ –º–æ–¥–∞–ª–∫–µ)
            
            // --- –ù–û–í–´–ï DOM –≠–õ–ï–ú–ï–ù–¢–´ (–î–µ—Ç–∞–ª–∏ –ó–∞–¥–∞—á–∏) ---
            const taskDetailModal = document.getElementById('taskDetailModal');
            const closeTaskDetailModalBtn = document.getElementById('closeTaskDetailModalBtn');
            const taskDetailTitle = document.getElementById('taskDetailTitle');
            const taskDetailDescriptionText = document.getElementById('taskDetailDescriptionText'); 
            const taskDetailDescriptionEdit = document.getElementById('taskDetailDescriptionEdit'); 
            const taskDetailSubtaskList = document.getElementById('taskDetailSubtaskList');
            const taskDetailNewSubtask = document.getElementById('taskDetailNewSubtask');
            const taskDetailAddSubtaskContainer = document.getElementById('taskDetailAddSubtaskContainer'); 
            const taskDetailAddSubtaskBtn = document.getElementById('taskDetailAddSubtaskBtn');
            const taskDetailSaveBtn = document.getElementById('taskDetailSaveBtn');
            const taskDetailEditBtn = document.getElementById('taskDetailEditBtn'); 

            // --- –ù–û–í–´–ï DOM –≠–õ–ï–ú–ï–ù–¢–´ (–°—Ç–∏–∫–µ—Ä—ã) ---
            const stickerBackdrop = document.getElementById('stickerBackdrop');
            const stickerModal = document.getElementById('stickerModal');
            const openStickerModalBtn = document.getElementById('openStickerModalBtn');
            const closeStickerModalBtn = document.getElementById('closeStickerModalBtn');
            const newStickerText = document.getElementById('newStickerText');
            const addStickerBtn = document.getElementById('addStickerBtn');
            
            // --- –ù–û–í–´–ï DOM –≠–õ–ï–ú–ï–ù–¢–´ (–ù–∞–≤–∏–≥–∞—Ü–∏—è) ---
            const navButtons = document.querySelectorAll('.nav-btn');
            const views = document.querySelectorAll('.view-container');
            const calendarViewEl = document.getElementById('calendarView'); // <-- –î–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            
            // --- –ù–û–í–´–ï DOM –≠–õ–ï–ú–ï–ù–¢–´ (–§–∏–ª—å—Ç—Ä—ã –ó–∞–¥–∞—á) ---
            const filterActiveBtn = document.getElementById('filterActive');
            const filterHighBtn = document.getElementById('filterHigh');
            const filterCompletedBtn = document.getElementById('filterCompleted');
            const hatSortBtn = document.getElementById('hatSortBtn');


            // --- –ê–£–î–ò–û (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            let audioInit = false;
            let brownNoise = null;
            const initAudio = async () => {
                if (audioInit) return;
                try {
                    await Tone.start();
                    window.addSynth = new Tone.PolySynth(Tone.Synth, { volume: -10 }).toDestination();
                    window.completeSynth = new Tone.MetalSynth({ volume: -15, harmonicity: 3.1 }).toDestination();
                    window.hatSynth = new Tone.PluckSynth({ volume: -5 }).toDestination();
                    window.alarmSynth = new Tone.Synth({ volume: -5 }).toDestination();
                    brownNoise = new Tone.Noise("brown").toDestination();
                    const filter = new Tone.AutoFilter({ frequency: "8m", min: 800, max: 3000 }).connect(Tone.Master);
                    brownNoise.connect(filter); filter.start();
                    brownNoise.volume.value = -Infinity; brownNoise.start();
                    audioInit = true;
                } catch (e) {
                    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ:", e);
                }
            };

            // --- –¶–í–ï–¢–ê –ò –ò–ú–ï–ù–ê –ö–ê–¢–ï–ì–û–†–ò–ô (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            const catColors = {
                students: '#3b82f6', home: '#d97706', projects: '#9333ea',
                hobbies: '#10b981', love: '#ec4899', shop: '#eab308', docs: '#64748b'
            };
            const catNames = {
                students: '–°—Ç—É–¥–µ–Ω—Ç—ã', home: '–î–æ–º', projects: '–ü—Ä–æ–µ–∫—Ç—ã',
                hobbies: '–•–æ–±–±–∏', love: '–õ—é–±–æ–≤—å', shop: '–ú–∞–≥–∞–∑–∏–Ω', docs: '–î–æ–∫—É–º–µ–Ω—Ç—ã'
            };
            
            // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ---
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ –í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            authTabLogin.addEventListener('click', () => {
                authTabLogin.classList.add('active');
                authTabRegister.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                authError.textContent = '';
            });
            authTabRegister.addEventListener('click', () => {
                authTabRegister.classList.add('active');
                authTabLogin.classList.remove('active');
                registerForm.style.display = 'block';
                loginForm.style.display = 'none';
                authError.textContent = '';
            });

            // –•–µ–ª–ø–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫ Firebase
            function showAuthError(error) {
                console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error.code, error.message);
                switch (error.code) {
                    case 'auth/invalid-email': authError.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email'; break;
                    case 'auth/user-not-found': authError.textContent = '–í–æ–ª—à–µ–±–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'; break;
                    case 'auth/wrong-password': authError.textContent = '–ù–µ–≤–µ—Ä–Ω–æ–µ —Ç–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ'; break;
                    case 'auth/email-already-in-use': authError.textContent = '–≠—Ç–æ—Ç email —É–∂–µ –∑–∞–Ω—è—Ç'; break;
                    case 'auth/weak-password': authError.textContent = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π'; break;
                    case 'auth/passwords-not-match': authError.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!'; break;
                    case 'auth/missing-nickname': authError.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º!'; break; 
                    default: authError.textContent = '–û—à–∏–±–∫–∞! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                }
            }

            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–û–±–Ω–æ–≤–ª–µ–Ω–æ)
            registerBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                const nickname = document.getElementById('registerNickname').value.trim(); 

                if (password !== confirmPassword) {
                    showAuthError({ code: 'auth/passwords-not-match' });
                    return;
                }
                
                if (!nickname) { 
                    showAuthError({ code: 'auth/missing-nickname' });
                    return;
                }
                
                authError.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Å–≤–∏—Ç–∫–∞...';
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫–Ω–µ–π–º –≤ Firestore
                    // –í–ê–ñ–ù–û: –ü—É—Ç—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫ 'public/data/users'
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, user.uid);
                    await setDoc(userDocRef, { 
                        nickname: nickname, 
                        email: email 
                    });
                    
                    // onAuthStateChanged —Å–∞–º –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
                    authError.textContent = '';
                } catch (error) {
                    showAuthError(error);
                }
            });

            // –í—Ö–æ–¥
            loginBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                authError.textContent = '–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–∞–ª–∞...';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged —Å–∞–º –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
                    authError.textContent = '';
                } catch (error) {
                    showAuthError(error);
                }
            });

            // –í—ã—Ö–æ–¥
            logoutBtn.addEventListener('click', () => {
                signOut(auth).catch(err => console.error("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", err));
            });

            // –ì–õ–ê–í–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ –°–û–°–¢–û–Ø–ù–ò–Ø AUTH (–û–±–Ω–æ–≤–ª–µ–Ω)
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // --- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –í–û–®–ï–õ ---
                    console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω:", user.uid);
                    currentUserId = user.uid;
                    
                    // –ü–æ–ª—É—á–∞–µ–º –Ω–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, user.uid);
                    let nickname = `–í–æ–ª—à–µ–±–Ω–∏–∫ ${user.uid.substring(0, 4)}`; // Default
                    try {
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            nickname = userDoc.data().nickname;
                        } else {
                            // –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞—Ä—ã–π –∏ —É –Ω–µ–≥–æ –Ω–µ—Ç –¥–æ–∫–∞
                            console.warn("–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º...");
                            await setDoc(userDocRef, { nickname: nickname, email: user.email });
                        }
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∏–∫–Ω–µ–π–º–∞:", e);
                    }
                    currentUserNickname = nickname; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±. —Å–æ—Å—Ç–æ—è–Ω–∏–µ

                    // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å ID –∏ –ù–∏–∫–Ω–µ–π–º–æ–º
                    currentUserDisplayEl.textContent = currentUserNickname; 
                    currentUserIndicatorEl.classList.remove('presence-offline');
                    currentUserIndicatorEl.classList.add('presence-online');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º ID –≤ –º–æ–¥–∞–ª–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                    fullCurrentUserIdSettings.textContent = user.uid;
                    fullCurrentUserIdSettings.onclick = () => {
                        const textArea = document.createElement("textarea");
                        textArea.value = user.uid;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            fullCurrentUserIdSettings.title = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!";
                            setTimeout(() => fullCurrentUserIdSettings.title = "–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", 2000);
                        } catch (err) { console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID', err); }
                        document.body.removeChild(textArea);
                    };

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Å–∫—Ä—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω
                    mainAppContainer.style.display = 'block';
                    authOverlay.style.display = 'none';

                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –≤—Ö–æ–¥–µ
                    if (!isAppInitialized) {
                        listenForTasks();
                        listenForStickers(); // <-- –ù–û–í–û–ï
                        setupPresence(); 
                        listenForOtherUserPresence();
                        isAppInitialized = true;
                    }

                } else {
                    // --- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –í–´–®–ï–õ ---
                    console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–æ—à–µ–ª.");
                    currentUserId = null;
                    currentUserNickname = null; 
                    isAppInitialized = false;

                    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω
                    mainAppContainer.style.display = 'none';
                    authOverlay.style.display = 'flex'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è

                    // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª–µ–π
                    if (tasksUnsubscribe) {
                        tasksUnsubscribe();
                        tasksUnsubscribe = null;
                        console.log("–û—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∑–∞–¥–∞—á (tasks)");
                    }
                    if (stickersUnsubscribe) { // <-- –ù–û–í–û–ï
                        stickersUnsubscribe();
                        stickersUnsubscribe = null;
                        console.log("–û—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –ø–æ–º–µ—Ç–æ–∫ (stickers)");
                    }
                    if (presenceUnsubscribe) {
                        presenceUnsubscribe();
                        presenceUnsubscribe = null;
                        console.log("–û—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è (presence)");
                    }
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
                    allTasks = [];
                    allStickers = []; // <-- –ù–û–í–û–ï
                    renderTasks(); // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–∫–∏
                    renderStickers(); // <-- –ù–û–í–û–ï
                    document.getElementById('otherUserName').textContent = "–û—Ñ—Ñ–ª–∞–π–Ω";
                    document.getElementById('otherUserIndicator').classList.remove('presence-online');
                    document.getElementById('otherUserIndicator').classList.add('presence-offline');
                    currentUserDisplayEl.textContent = "..."; 
                    currentUserIndicatorEl.classList.remove('presence-online'); 
                    currentUserIndicatorEl.classList.add('presence-offline'); 
                    fullCurrentUserIdSettings.textContent = "...";
                }
            });

            // (–û–±–Ω–æ–≤–ª–µ–Ω–æ)
            function setupPresence() {
                if (!currentUserId || !currentUserNickname) return; // –ñ–¥–µ–º –∏ ID –∏ –ù–∏–∫–Ω–µ–π–º
                
                const userStatusRef = ref(rtdb, `/artifacts/${appId}/presence/${currentUserId}`);
                const userInfo = {
                    online: true,
                    name: currentUserNickname, // <-- –ò–°–ü–û–õ–¨–ó–£–ï–ú –ù–ò–ö–ù–ï–ô–ú
                    lastSeen: new Date().toISOString()
                };
                
                set(userStatusRef, userInfo);
                
                onDisconnect(userStatusRef).set({
                    ...userInfo,
                    online: false,
                    lastSeen: new Date().toISOString()
                });
            }

            function listenForOtherUserPresence() {
                if (!currentUserId) return;
                if (presenceUnsubscribe) presenceUnsubscribe(); // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ
                
                const presenceRef = ref(rtdb, `/artifacts/${appId}/presence`);
                presenceUnsubscribe = onValue(presenceRef, (snapshot) => {
                    if (!currentUserId) return; // –î–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –≤—ã—Ö–æ–¥–∞
                    const allUsers = snapshot.val();
                    let otherUserFound = false;
                    if (allUsers) {
                        for (const uid in allUsers) {
                            if (uid !== currentUserId) {
                                const otherUser = allUsers[uid];
                                const indicator = document.getElementById('otherUserIndicator');
                                const nameEl = document.getElementById('otherUserName');
                                
                                nameEl.textContent = otherUser.name; // <-- –¢–µ–ø–µ—Ä—å –∑–¥–µ—Å—å –±—É–¥–µ—Ç –Ω–∏–∫–Ω–µ–π–º
                                if (otherUser.online) {
                                    indicator.classList.remove('presence-offline');
                                    indicator.classList.add('presence-online');
                                } else {
                                    indicator.classList.remove('presence-online');
                                    indicator.classList.add('presence-offline');
                                }
                                otherUserFound = true;
                                break; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            }
                        }
                    }
                    if (!otherUserFound) {
                        document.getElementById('otherUserName').textContent = "–û—Ñ—Ñ–ª–∞–π–Ω";
                        document.getElementById('otherUserIndicator').classList.remove('presence-online');
                        document.getElementById('otherUserIndicator').classList.add('presence-offline');
                    }
                });
            }

            
            // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò ---
            
            function showView(viewId) {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ
                views.forEach(view => view.classList.add('hidden'));
                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
                navButtons.forEach(btn => btn.classList.remove('active'));
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
                const viewToShow = document.getElementById(viewId);
                // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –ø–æ ID, –∞ –Ω–µ –ø–æ –∑–∞–º–µ–Ω–µ
                const buttonToActivate = document.getElementById('nav-' + viewId.replace('View', ''));
                
                if (viewToShow) viewToShow.classList.remove('hidden');
                if (buttonToActivate) buttonToActivate.classList.add('active');
                
                // –í–ê–ñ–ù–û: –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –µ—Å–ª–∏ –º—ã –µ–≥–æ –æ—Ç–∫—Ä—ã–ª–∏
                if (viewId === 'calendarView') {
                    if (!calendar) {
                        initCalendar();
                    } else {
                        calendar.render();
                    }
                }
            }
            
            navButtons.forEach(button => {
                // –ò—Å–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–æ–≤–∞—è –ü–æ–º–µ—Ç–∫–∞" –∏–∑ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—å—é—à–µ–∫
                if (button.id === 'openStickerModalBtn') return; 
                
                button.addEventListener('click', () => {
                    // e.g., 'nav-tasks' -> 'tasksView'
                    const viewId = button.id.replace('nav-', '') + 'View';
                    showView(viewId);
                });
            });
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—å—é—à–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            showView('tasksView');
            

            // --- –õ–û–ì–ò–ö–ê –ó–ê–î–ê–ß (FIRESTORE) ---

            function listenForTasks() {
                if (!currentUserId) return;
                if (tasksUnsubscribe) tasksUnsubscribe(); // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ
                
                const tasksCol = collection(db, `/artifacts/${appId}/public/data/tasks`);
                tasksUnsubscribe = onSnapshot(tasksCol, (snapshot) => {
                    allTasks = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date ? (data.date.toDate ? data.date.toDate() : new Date(data.date)) : null
                        };
                    });
                    
                    allTasks.sort((a, b) => {
                        const statusOrder = { 'inProgress': 1, 'pending': 2, 'completed': 3 };
                        if (statusOrder[a.status] !== statusOrder[b.status]) {
                            return statusOrder[a.status] - statusOrder[b.status];
                        }
                        if (a.date && !b.date) return -1;
                        if (!a.date && b.date) return 1;
                        if (!a.date && !b.date) return 0;
                        return a.date - b.date;
                    });
                    
                    renderTasks();
                    
                    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–õ–ï–ù–î–ê–†–Ø ---
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –±—ã–ª
                    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –Ω–µ –≤–∏–¥–µ–Ω.
                    if(calendar) {
                        calendar.render(); 
                    }
                }, (error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á:", error);
                    taskListEl.innerHTML = '<p class="text-center text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</p>';
                });
            }

            // --- –†–ï–ù–î–ï–†–ò–ù–ì –ó–ê–î–ê–ß (–°–ü–ò–°–û–ö) ---
            const renderTasks = () => {
                taskListEl.innerHTML = '';
                
                let tasksToRender = [];
                
                if (currentFilter === 'completed') {
                    tasksToRender = allTasks.filter(t => t.status === 'completed');
                    hatSortBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º "–®–ª—è–ø—É" –≤ –ê—Ä—Ö–∏–≤–µ
                } else if (currentFilter === 'high') {
                    tasksToRender = allTasks.filter(t => (t.status === 'pending' || t.status === 'inProgress') && t.priority === 'high');
                    hatSortBtn.style.display = 'inline-block';
                } else {
                    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 'active'
                    tasksToRender = allTasks.filter(t => t.status === 'pending' || t.status === 'inProgress');
                    hatSortBtn.style.display = 'inline-block';
                }

                if (tasksToRender.length === 0) {
                    let message = "–°–≤–∏—Ç–æ–∫ –ø—É—Å—Ç...";
                    if (currentFilter === 'completed') message = "–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç...";
                    if (currentFilter === 'high') message = "–°—Ä–æ—á–Ω—ã—Ö –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π –Ω–µ—Ç...";
                    taskListEl.innerHTML = `<p class="text-center text-gray-500 italic">${message}</p>`;
                } else {
                    tasksToRender.forEach(task => taskListEl.appendChild(createTaskElement(task)));
                }
            };

            // (–û–±–Ω–æ–≤–ª–µ–Ω–æ)
            function createTaskElement(task) {
                const el = document.createElement('div');
                const tagColor = catColors[task.category] || '#666';
                const taskDate = task.date ? new Date(task.date) : null;
                const dateString = taskDate ? taskDate.toLocaleString('ru', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' }) : '';

                let buttons = '';
                let statusIndicator = '';

                if (task.status === 'pending') {
                    buttons = `
                        <button class="task-spell-btn bg-blue-600 text-white border-blue-700 hover:bg-blue-700" onclick="window.startTask('${task.id}')" title="–ù–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ">‚ñ∂</button>
                    `;
                } else if (task.status === 'inProgress') {
                    statusIndicator = `<span class="text-xs font-bold text-purple-700 animate-pulse ml-2">(–í –ø—Ä–æ—Ü–µ—Å—Å–µ...)</span>`;
                    buttons = `
                        <button class="task-spell-btn bg-green-600 text-white border-green-700 hover:bg-green-700" onclick="window.completeTask('${task.id}')" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">‚úì</button>
                    `;
                } else if (task.status === 'completed') {
                    buttons = `
                        <button class="task-spell-btn bg-gray-500 text-white border-gray-600 hover:bg-gray-600" onclick="window.reactivateTask('${task.id}')" title="–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞">‚Ü©Ô∏è</button>
                    `;
                }
                buttons += ` <button class="task-spell-btn bg-red-600 text-white border-red-700 hover:bg-red-700" onclick="window.deleteTask('${task.id}')" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>`;

                el.className = `task-item p-3 bg-white bg-opacity-80 rounded-lg shadow-sm priority-${task.priority} status-${task.status} mb-2`;
                el.innerHTML = `
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-grow">
                            <span class="task-tag" style="background-color: ${tagColor}">${catNames[task.category]}</span>
                            <!-- –ù–û–í–û–ï: –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ —Å—Ç–∞–ª–æ –∫–Ω–æ–ø–∫–æ–π -->
                            <span class="text-gray-900 font-medium cursor-pointer hover:underline" onclick="window.showTaskDetails('${task.id}')">${task.text}</span>
                            ${statusIndicator}
                            ${taskDate ? `<div class="text-xs text-yellow-900 font-bold mt-1">üìÖ ${dateString}</div>` : ''}
                        </div>
                        <div class="flex gap-2 flex-shrink-0">
                            ${buttons}
                        </div>
                    </div>
                `;
                return el;
            }

            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏
            window.startTask = async (id) => {
                if (!currentUserId) return;
                const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, id);
                try {
                    await updateDoc(taskRef, { status: 'inProgress' });
                } catch (e) { console.error("–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞ –∑–∞–¥–∞—á–∏:", e); }
            };

            window.completeTask = async (id) => {
                if (!currentUserId) return;
                const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, id);
                try {
                    await updateDoc(taskRef, { status: 'completed' });
                    if (audioInit) window.completeSynth.triggerAttackRelease("C6", "8n");
                    confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 } });
                } catch (e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:", e); }
            };

            window.reactivateTask = async (id) => {
                if (!currentUserId) return;
                const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, id);
                try {
                    await updateDoc(taskRef, { status: 'pending' });
                } catch (e) { console.error("–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏:", e); }
            };

            window.deleteTask = async (id) => {
                if (!currentUserId) return;
                const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, id);
                try {
                    await deleteDoc(taskRef);
                } catch (e) { console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:", e); }
            };

            // --- –ö–ê–õ–ï–ù–î–ê–†–¨ (INIT - –û–±–Ω–æ–≤–ª–µ–Ω) ---
            const initCalendar = () => {
                const calendarEl = document.getElementById('calendar');
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ru',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth' // –£–±—Ä–∞–ª 'timeGridWeek'
                    },
                    height: 'auto',
                    
                    events: (info, successCallback) => {
                        successCallback([]); 
                    },

                    // –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–õ–ò–ö–ê –ù–ê –î–ï–ù–¨
                    dateClick: (arg) => {
                        showDayViewModal(arg.date);
                    },

                    // –ù–û–í–´–ô –†–ï–ù–î–ï–†–ò–ù–ì –Ø–ß–ï–ï–ö
                    dayCellDidMount: (arg) => {
                        // 1. –°—á–∏—Ç–∞–µ–º –∑–∞–¥–∞—á–∏ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
                        const dayStart = arg.date;
                        const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000 - 1);

                        const tasksForDay = allTasks.filter(t => 
                            t.date && t.date >= dayStart && t.date < dayEnd
                        );

                        if (tasksForDay.length > 0) {
                            const total = tasksForDay.length;
                            const completed = tasksForDay.filter(t => t.status === 'completed').length;
                            
                            let countClass = 'day-task-count';
                            if (completed === total) {
                                countClass = 'day-task-count day-task-count-completed';
                            } else if (completed > 0) {
                                countClass = 'day-task-count day-task-count-mixed';
                            }

                            // 2. –°–æ–∑–¥–∞–µ–º HTML
                            const countEl = document.createElement('div');
                            countEl.className = countClass;
                            countEl.innerHTML = `${completed} / ${total}`;
                            
                            // 3. –î–æ–±–∞–≤–ª—è–µ–º –≤ —è—á–µ–π–∫—É (–≤–Ω—É—Ç—Ä—å 'fc-daygrid-day-frame')
                            // –ò—â–µ–º frame, —Ç.–∫. arg.el —ç—Ç–æ –≤—Å—è <td>
                            const frame = arg.el.querySelector('.fc-daygrid-day-frame');
                            if(frame) frame.appendChild(countEl);
                        }
                        
                        // 4. –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –≤—Å—é —è—á–µ–π–∫—É
                        // (–ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–± –Ω–µ –¥–æ–±–∞–≤–∏—Ç—å –¥–≤–∞–∂–¥—ã)
                        if (!arg.el.dataset.listenerAdded) {
                            arg.el.addEventListener('click', () => {
                                showDayViewModal(arg.date);
                            });
                            arg.el.dataset.listenerAdded = 'true';
                        }
                    }
                });
                calendar.render();
            };
            
            // --- –§–£–ù–ö–¶–ò–Ø: –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–Ω—è (–û–±–Ω–æ–≤–ª–µ–Ω–æ) ---
            function showDayViewModal(date) {
                // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞—Ç—É, —á—Ç–æ–±—ã –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª
                const dateCopy = new Date(date.getTime());
                const dayStart = new Date(dateCopy.setHours(0, 0, 0, 0));
                const dayEnd = new Date(dateCopy.setHours(23, 59, 59, 999));

                const tasksForDay = allTasks
                    .filter(t => t.date && t.date >= dayStart && t.date <= dayEnd)
                    .sort((a, b) => a.date - b.date); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                
                document.getElementById('dayViewTitle').textContent = `–ü–ª–∞–Ω –Ω–∞: ${date.toLocaleDateString('ru', {day: 'numeric', month: 'long', year: 'numeric'})}`;
                const dayTaskListEl = document.getElementById('dayViewTaskList');
                dayTaskListEl.innerHTML = '';

                if (tasksForDay.length === 0) {
                    dayTaskListEl.innerHTML = '<p class="text-center text-gray-500 italic">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π –Ω–µ—Ç.</p>';
                } else {
                    tasksForDay.forEach(task => {
                        const el = document.createElement('div');
                        el.className = `p-3 rounded-lg flex items-center gap-3 status-${task.status} task-item`;
                        const tagColor = catColors[task.category] || '#666';
                        
                        el.innerHTML = `
                            <div class="flex-shrink-0 w-20 text-center font-bold text-yellow-900 bg-yellow-100 p-2 rounded">
                                ${task.date.toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                            <div class="flex-grow">
                                <span class="task-tag" style="background-color: ${tagColor}">${catNames[task.category]}</span>
                                <!-- –ù–û–í–û–ï: –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ —Å—Ç–∞–ª–æ –∫–Ω–æ–ø–∫–æ–π -->
                                <span class="font-medium cursor-pointer hover:underline" onclick="window.showTaskDetails('${task.id}')">${task.text}</span>
                                ${task.status === 'inProgress' ? '<span class="text-xs font-bold text-purple-700 ml-2">(–í –ø—Ä–æ—Ü–µ—Å—Å–µ...)</span>' : ''}
                                ${task.status === 'completed' ? '<span class="text-xs font-bold text-green-700 ml-2">(–ì–æ—Ç–æ–≤–æ)</span>' : ''}
                            </div>
                        `;
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º–æ –≤ –º–æ–¥–∞–ª–∫—É
                        const controls = document.createElement('div');
                        controls.className = 'flex gap-2 flex-shrink-0';
                        if (task.status === 'pending') {
                             controls.innerHTML = `<button class="task-spell-btn bg-blue-600 text-white border-blue-700 hover:bg-blue-700" onclick="window.startTask('${task.id}')" title="–ù–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ">‚ñ∂</button>`;
                        } else if (task.status === 'inProgress') {
                             controls.innerHTML = `<button class="task-spell-btn bg-green-600 text-white border-green-700 hover:bg-green-700" onclick="window.completeTask('${task.id}')" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">‚úì</button>`;
                        } else if (task.status === 'completed') {
                             controls.innerHTML = `<button class="task-spell-btn bg-gray-500 text-white border-gray-600 hover:bg-gray-600" onclick="window.reactivateTask('${task.id}')" title="–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞">‚Ü©Ô∏è</button>`;
                        }
                        controls.innerHTML += ` <button class="task-spell-btn bg-red-600 text-white border-red-700 hover:bg-red-700" onclick="window.deleteTask('${task.id}')" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>`;
                        
                        el.appendChild(controls);
                        dayTaskListEl.appendChild(el);
                    });
                }
                
                dayViewModal.style.display = 'flex';
            }
            document.getElementById('closeDayViewModalBtn').addEventListener('click', () => dayViewModal.style.display = 'none');
            dayViewModal.addEventListener('click', (e) => { if(e.target === dayViewModal) dayViewModal.style.display = 'none'; });


            // --- –¢–ê–ô–ú–ï–† (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            let timerTime = 25 * 60; let defaultTime = 25; let timerInterval = null; let isRunning = false;
            const timerDisplay = document.getElementById('timerDisplay'); const timerInput = document.getElementById('timerInput');
            const timerStatus = document.getElementById('timerStatus'); const startTimerBtn = document.getElementById('startTimerBtn');
            const updateDisplay = () => {
                const m = Math.floor(timerTime / 60).toString().padStart(2, '0');
                const s = (timerTime % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${m}:${s}`;
            };
            document.getElementById('timerSettingsBtn').addEventListener('click', () => {
                if (isRunning) return; 
                const isEditing = !timerInput.classList.contains('hidden');
                if (isEditing) {
                    let newVal = parseInt(timerInput.value);
                    if (newVal > 0 && newVal <= 180) { defaultTime = newVal; timerTime = defaultTime * 60; updateDisplay(); }
                    timerInput.classList.add('hidden'); timerDisplay.classList.remove('opacity-0');
                } else {
                    timerInput.value = defaultTime; timerInput.classList.remove('hidden');
                    timerInput.focus(); timerDisplay.classList.add('opacity-0');
                }
            });
            timerInput.addEventListener('blur', () => { if(!timerInput.classList.contains('hidden')) document.getElementById('timerSettingsBtn').click(); });
            timerInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') timerInput.blur(); });
            startTimerBtn.addEventListener('click', () => {
                if (!audioInit) initAudio();
                if (isRunning) {
                    clearInterval(timerInterval); isRunning = false;
                    startTimerBtn.textContent = "–í–∞—Ä–∏—Ç—å!"; timerStatus.textContent = "–ó–µ–ª—å–µ –Ω–∞ –ø–∞—É–∑–µ";
                } else {
                    isRunning = true; startTimerBtn.textContent = "–ü–∞—É–∑–∞"; timerStatus.textContent = "–ó–µ–ª—å–µ –≤–∞—Ä–∏—Ç—Å—è...";
                    timerInterval = setInterval(() => {
                        timerTime--; updateDisplay();
                        if (timerTime <= 0) {
                            clearInterval(timerInterval); isAppInitialized = false;
                            if(audioInit) window.alarmSynth.triggerAttackRelease("C5", "1s");
                            timerStatus.textContent = "–ì–æ—Ç–æ–≤–æ! –û—Ç–¥–æ—Ö–Ω–∏—Ç–µ."; startTimerBtn.textContent = "–í–∞—Ä–∏—Ç—å!";
                            timerTime = defaultTime * 60;
                        }
                    }, 1000);
                }
            });
            document.getElementById('resetTimerBtn').addEventListener('click', () => {
                clearInterval(timerInterval); isRunning = false;
                timerTime = defaultTime * 60; updateDisplay();
                startTimerBtn.textContent = "–í–∞—Ä–∏—Ç—å!"; timerStatus.textContent = "–ö–æ—Ç–µ–ª–æ–∫ –ø—É—Å—Ç";
            });
            document.getElementById('noiseToggleBtn').addEventListener('click', function() {
                if(!audioInit) initAudio();
                if (this.classList.contains('active')) {
                    brownNoise.volume.rampTo(-Infinity, 1); this.classList.remove('active'); this.style.opacity = 0.6;
                } else {
                    brownNoise.volume.rampTo(-12, 1); this.classList.add('active'); this.style.opacity = 1;
                }
            });

            // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–î–ê–ß–ò (–û–±–Ω–æ–≤–ª–µ–Ω–æ) ---
            const datePicker = flatpickr("#taskDueDate", { locale: "ru", enableTime: true, time_24hr: true, dateFormat: "Y-m-d H:i" });
            
            openTaskModalBtn.addEventListener('click', () => { modal.style.display = 'flex'; if(!audioInit) initAudio(); });
            document.getElementById('closeTaskModalBtn').addEventListener('click', () => modal.style.display = 'none');
            modal.addEventListener('click', (e) => { if(e.target === modal) modal.style.display = 'none'; });

            document.getElementById('addTaskBtn').addEventListener('click', async () => {
                if (!currentUserId) {
                    console.error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É");
                    return;
                }
                const text = document.getElementById('taskInput').value.trim();
                if (!text) return;
                
                const taskDate = document.getElementById('taskDueDate').value;

                const newTask = {
                    text: text,
                    description: document.getElementById('taskDescriptionInput').value.trim() || '', // <-- –ù–û–í–û–ï
                    subtasks: [], // <-- –ù–û–í–û–ï
                    date: taskDate ? Timestamp.fromDate(new Date(taskDate)) : null,
                    priority: document.getElementById('taskPriority').value,
                    category: document.querySelector('input[name="taskCat"]:checked').value,
                    status: 'pending', // –ù–û–í–´–ô –°–¢–ê–¢–£–°
                    createdBy: currentUserId // –°–æ—Ö—Ä–∞–Ω—è–µ–º, –∫—Ç–æ —Å–æ–∑–¥–∞–ª
                };
                
                try {
                    const tasksCol = collection(db, `/artifacts/${appId}/public/data/tasks`);
                    await addDoc(tasksCol, newTask);
                    
                    // –û—á–∏—Å—Ç–∫–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ
                    document.getElementById('taskInput').value = '';
                    document.getElementById('taskDescriptionInput').value = ''; // <-- –ù–û–í–û–ï
                    datePicker.clear();
                    modal.style.display = 'none';
                    if(audioInit) window.addSynth.triggerAttackRelease(["C4", "E4"], "8n");
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:", e);
                }
            });

            // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–ò–õ–¨–¢–†–û–í (–ó–∞–¥–∞—á) ---
            filterActiveBtn.addEventListener('click', (e) => {
                currentFilter = 'active';
                updateFilterButtons(e.target);
                renderTasks();
            });
            filterHighBtn.addEventListener('click', (e) => {
                currentFilter = 'high';
                updateFilterButtons(e.target);
                renderTasks();
            });
            filterCompletedBtn.addEventListener('click', (e) => {
                currentFilter = 'completed';
                updateFilterButtons(e.target);
                renderTasks();
            });
            
            function updateFilterButtons(activeButton) {
                // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                [filterActiveBtn, filterHighBtn, filterCompletedBtn].forEach(btn => {
                    btn.classList.remove('active');
                });
                if (activeButton) {
                    activeButton.classList.add('active');
                }
            }
            updateFilterButtons(filterActiveBtn); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

            // "–®–ª—è–ø–∞" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
            hatSortBtn.addEventListener('click', () => {
                if(!audioInit) initAudio();
                const activeTasks = allTasks.filter(t => t.status === 'pending' || t.status === 'inProgress');
                if(activeTasks.length === 0) {
                    console.warn("–®–ª—è–ø–µ –Ω–µ—á–µ–≥–æ –≤—ã–±–∏—Ä–∞—Ç—å!");
                    // TODO: –ó–∞–º–µ–Ω–∏—Ç—å alert –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    alert("üé© –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è!");
                    return;
                }
                const randomTask = activeTasks[Math.floor(Math.random() * activeTasks.length)];
                // TODO: –ó–∞–º–µ–Ω–∏—Ç—å alert –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                alert(`üé© –®–ª—è–ø–∞ –≤—ã–±—Ä–∞–ª–∞: "${randomTask.text}"!`);
                if(audioInit) window.hatSynth.triggerAttackRelease("G4", "8n");
            });

            // --- –ù–û–í–´–ï –°–õ–£–®–ê–¢–ï–õ–ò (–ù–∞—Å—Ç—Ä–æ–π–∫–∏) ---
            openSettingsBtn.addEventListener('click', () => {
                if (currentUserNickname) {
                    nicknameInput.value = currentUserNickname;
                }
                settingsModal.style.display = 'flex';
            });
            closeSettingsModalBtn.addEventListener('click', () => settingsModal.style.display = 'none');
            settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) settingsModal.style.display = 'none'; });
            
            saveNicknameBtn.addEventListener('click', async () => {
                const newNickname = nicknameInput.value.trim();
                if (!newNickname || newNickname === currentUserNickname || !currentUserId) {
                    settingsModal.style.display = 'none';
                    return;
                }

                saveNicknameBtn.disabled = true;
                saveNicknameBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

                try {
                    // 1. –û–±–Ω–æ–≤–∏—Ç—å Firestore
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUserId);
                    await updateDoc(userDocRef, { nickname: newNickname });

                    // 2. –û–±–Ω–æ–≤–∏—Ç—å Realtime Database (–¥–ª—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞)
                    const userStatusRef = ref(rtdb, `/artifacts/${appId}/presence/${currentUserId}/name`);
                    await set(userStatusRef, newNickname);
                    
                    // 3. –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
                    currentUserNickname = newNickname;
                    currentUserDisplayEl.textContent = newNickname;

                    settingsModal.style.display = 'none';
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∏–∫–Ω–µ–π–º–∞:", e);
                    // TODO: –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                } finally {
                    saveNicknameBtn.disabled = false;
                    saveNicknameBtn.textContent = "‚ú® –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚ú®";
                }
            });

            // --- –ù–û–í–´–ï –°–õ–£–®–ê–¢–ï–õ–ò –ò –§–£–ù–ö–¶–ò–ò (–î–µ—Ç–∞–ª–∏ –ó–∞–¥–∞—á–∏) ---
            
            // (–û–±–Ω–æ–≤–ª–µ–Ω–æ) –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
            window.showTaskDetails = (id) => {
                currentEditingTaskId = id;
                const task = allTasks.find(t => t.id === id);
                if (!task) {
                    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–¥–∞—á—É!");
                    return;
                }
                
                // 1. –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±–∞ –ø–æ–ª—è (–≤–∏–¥–∏–º–æ–µ –∏ —Å–∫—Ä—ã—Ç–æ–µ)
                taskDetailTitle.textContent = task.text;
                taskDetailDescriptionText.textContent = task.description || '...';
                taskDetailDescriptionEdit.value = task.description || '';
                
                // 2. –í—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ —Ä–µ–∂–∏–º–µ "–ø—Ä–æ—Å–º–æ—Ç—Ä–∞"
                toggleTaskDetailEdit(false); 
                renderSubtasks(task.subtasks || [], false); // false = –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π
                
                taskDetailModal.style.display = 'flex';
            };

            // (–û–±–Ω–æ–≤–ª–µ–Ω–æ) –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
            closeTaskDetailModalBtn.addEventListener('click', () => {
                taskDetailModal.style.display = 'none';
                currentEditingTaskId = null;
                isTaskDetailEditing = false; // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            });
            // (–û–±–Ω–æ–≤–ª–µ–Ω–æ) –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            taskDetailModal.addEventListener('click', (e) => { 
                if(e.target === taskDetailModal) {
                    taskDetailModal.style.display = 'none';
                    currentEditingTaskId = null;
                    isTaskDetailEditing = false; // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
                }
            });

            // (–û–±–Ω–æ–≤–ª–µ–Ω–æ) –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –ø–æ–¥–∑–∞–¥–∞—á
            function renderSubtasks(subtasks, isEditing) {
                taskDetailSubtaskList.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞
                if (subtasks.length === 0) {
                    taskDetailSubtaskList.innerHTML = '<p class="text-center text-sm text-gray-600 italic">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç...</p>';
                    return;
                }
                subtasks.forEach((subtask, index) => {
                    const el = document.createElement('div');
                    el.className = 'subtask-item';
                    if (isEditing) {
                        // –†–µ–∂–∏–º –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        el.innerHTML = `
                            <input type="checkbox" ${subtask.done ? 'checked' : ''} onchange="window.toggleSubtask(${index}, this.checked)">
                            <input type="text" class="magic-input subtask-text" value="${subtask.text}">
                            <button class="subtask-delete-btn" data-index="${index}">&times;</button>
                        `;
                    } else {
                        // –†–µ–∂–∏–º –ü—Ä–æ—Å–º–æ—Ç—Ä–∞
                        el.innerHTML = `
                            <input type="checkbox" ${subtask.done ? 'checked' : ''} disabled>
                            <span class="magic-input subtask-text ${subtask.done ? 'line-through opacity-70' : ''}" style="background: #fff9; border-style: dashed; cursor: default;">${subtask.text}</span>
                        `;
                    }
                    taskDetailSubtaskList.appendChild(el);
                });
            }
            
            // --- –ù–û–í–û–ï: –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏ ---
            window.toggleSubtask = async (subtaskIndex, isChecked) => {
                if (!currentEditingTaskId) return;
                
                // 1. –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫—ç—à–µ
                const task = allTasks.find(t => t.id === currentEditingTaskId);
                if (!task) return;
                
                // 2. –ì–ª—É–±–æ–∫–æ –∫–æ–ø–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –ø–æ–¥–∑–∞–¥–∞—á, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –º—É—Ç–∞—Ü–∏–π
                const newSubtasks = JSON.parse(JSON.stringify(task.subtasks || []));
                
                // 3. –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–∂–Ω—É—é
                if (newSubtasks[subtaskIndex]) {
                    newSubtasks[subtaskIndex].done = isChecked;
                }
                
                // 4. –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –≤ Firebase
                try {
                    const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, currentEditingTaskId);
                    await updateDoc(taskRef, {
                        subtasks: newSubtasks
                    });
                    // onSnapshot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç allTasks –∏ –ø–µ—Ä–µ—Ä–∏—Å—É–µ—Ç
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–∑–∞–¥–∞—á–∏:", e);
                }
            };


            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–¥–∑–∞–¥–∞—á–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)
            taskDetailAddSubtaskBtn.addEventListener('click', () => {
                const text = taskDetailNewSubtask.value.trim();
                if (!text) return;

                // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –ø–æ–¥–∑–∞–¥–∞—á–∞, –æ—á–∏—Å—Ç–∏—Ç—å "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç"
                if (!taskDetailSubtaskList.querySelector('.subtask-item')) {
                    taskDetailSubtaskList.innerHTML = '';
                }

                const el = document.createElement('div');
                el.className = 'subtask-item';
                el.innerHTML = `
                    <input type="checkbox">
                    <input type="text" class="magic-input subtask-text" value="${text}">
                    <button class="subtask-delete-btn">&times;</button>
                `;
                taskDetailSubtaskList.appendChild(el);
                taskDetailNewSubtask.value = ''; // –û—á–∏—Å—Ç–∏—Ç—å –∏–Ω–ø—É—Ç
            });
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ Enter
            taskDetailNewSubtask.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    taskDetailAddSubtaskBtn.click();
                }
            });

            // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏ (–ª–æ–∫–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
            taskDetailSubtaskList.addEventListener('click', (e) => {
                if (e.target.classList.contains('subtask-delete-btn')) {
                    e.target.closest('.subtask-item').remove();
                    // –ï—Å–ª–∏ –ø–æ–¥–∑–∞–¥–∞—á –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, –ø–æ–∫–∞–∑–∞—Ç—å "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç"
                    if (!taskDetailSubtaskList.querySelector('.subtask-item')) {
                        taskDetailSubtaskList.innerHTML = '<p class="text-center text-sm text-gray-600 italic">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç...</p>';
                    }
                }
            });

            // (–û–±–Ω–æ–≤–ª–µ–Ω–æ) –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –î–µ—Ç–∞–ª—è—Ö –ó–∞–¥–∞—á–∏
            taskDetailSaveBtn.addEventListener('click', async () => {
                if (!currentEditingTaskId) return;

                taskDetailSaveBtn.disabled = true;
                taskDetailSaveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

                const newDescription = taskDetailDescriptionEdit.value.trim(); // <-- –ß–∏—Ç–∞–µ–º –∏–∑ textarea
                const newSubtasks = [];

                // –°–æ–±—Ä–∞—Ç—å –≤—Å–µ –ø–æ–¥–∑–∞–¥–∞—á–∏ –∏–∑ DOM
                taskDetailSubtaskList.querySelectorAll('.subtask-item').forEach(itemEl => {
                    const textInput = itemEl.querySelector('.subtask-text');
                    const text = textInput ? textInput.value.trim() : ''; // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ input –µ—Å—Ç—å
                    const done = itemEl.querySelector('input[type="checkbox"]').checked;
                    if (text) { // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç
                        newSubtasks.push({ text, done });
                    }
                });

                try {
                    const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, currentEditingTaskId);
                    await updateDoc(taskRef, {
                        description: newDescription,
                        subtasks: newSubtasks
                    });
                    
                    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É (onSnapshot —Å–∞–º –æ–±–Ω–æ–≤–∏—Ç allTasks)
                    taskDetailModal.style.display = 'none';
                    currentEditingTaskId = null;
                    isTaskDetailEditing = false; // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è

                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏:", e);
                } finally {
                    taskDetailSaveBtn.disabled = false;
                    taskDetailSaveBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ò–∑–º–µ–Ω–µ–Ω–∏—è";
                }
            });
            
            // --- –ù–û–í–û–ï: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ó–∞–¥–∞—á–∏ ---
            function toggleTaskDetailEdit(isEditing) {
                const task = allTasks.find(t => t.id === currentEditingTaskId);
                if (!task) return;

                isTaskDetailEditing = isEditing;
                
                // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
                taskDetailEditBtn.classList.toggle('hidden', isEditing);
                taskDetailSaveBtn.classList.toggle('hidden', !isEditing);
                taskDetailAddSubtaskContainer.classList.toggle('hidden', !isEditing);
                taskDetailDescriptionText.classList.toggle('hidden', isEditing);
                taskDetailDescriptionEdit.classList.toggle('hidden', !isEditing);
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á–∏ –≤ –Ω—É–∂–Ω–æ–º —Ä–µ–∂–∏–º–µ
                renderSubtasks(task.subtasks || [], isEditing);
            }

            taskDetailEditBtn.addEventListener('click', () => {
                toggleTaskDetailEdit(true);
            });
            
            // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò (–°—Ç–∏–∫–µ—Ä—ã) ---
            
            // –°–ª—É—à–∞—Ç–µ–ª—å
            function listenForStickers() {
                if (stickersUnsubscribe) stickersUnsubscribe();
                const stickersCol = collection(db, `/artifacts/${appId}/public/data/stickers`);
                stickersUnsubscribe = onSnapshot(stickersCol, (snapshot) => {
                    allStickers = snapshot.docs.map(doc => { 
                        const data = doc.data();
                        return {
                            id: doc.id, 
                            ...data, 
                            createdAt: data.createdAt ? data.createdAt.toDate() : new Date() 
                        }
                    });
                    renderStickers();
                }, (error) => console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–º–µ—Ç–æ–∫:", error));
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
            function renderStickers() {
                stickerBackdrop.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ñ–æ–Ω
                
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞–π–º–µ—Ä–µ
                const timerRect = {
                    x: window.innerWidth - 220 - 20, // 220-width, 20-padding
                    y: 20,
                    w: 220,
                    h: 150 // 
                };
                const stickerSize = { w: 200, h: 200 };

                allStickers.forEach(sticker => {
                    const el = document.createElement('div');
                    el.className = 'sticker-note-absolute';
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
                    let x, y, isOverlapping;
                    do {
                        // –†–∞–Ω–¥–æ–º–Ω—ã–µ X –∏ Y –≤ %
                        const xPercent = 5 + Math.random() * 80; // 5% to 85%
                        const yPercent = 10 + Math.random() * 70; // 10% to 80%
                        
                        x = (xPercent / 100) * window.innerWidth;
                        y = (yPercent / 100) * window.innerHeight;
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ç–∞–π–º–µ—Ä
                        const stickerRight = x + stickerSize.w;
                        const stickerBottom = y + stickerSize.h;
                        
                        const timerRight = timerRect.x + timerRect.w;
                        const timerBottom = timerRect.y + timerRect.h;

                        isOverlapping = (
                            stickerRight > timerRect.x && // –ü—Ä–∞–≤—ã–π –∫—Ä–∞–π —Å—Ç–∏–∫–µ—Ä–∞ –ø—Ä–∞–≤–µ–µ –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è —Ç–∞–π–º–µ—Ä–∞
                            x < timerRight &&           // –õ–µ–≤—ã–π –∫—Ä–∞–π —Å—Ç–∏–∫–µ—Ä–∞ –ª–µ–≤–µ–µ –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è —Ç–∞–π–º–µ—Ä–∞
                            stickerBottom > timerRect.y &&// –ù–∏–∑ —Å—Ç–∏–∫–µ—Ä–∞ –Ω–∏–∂–µ –≤–µ—Ä—Ö–∞ —Ç–∞–π–º–µ—Ä–∞
                            y < timerBottom             // –í–µ—Ä—Ö —Å—Ç–∏–∫–µ—Ä–∞ –≤—ã—à–µ –Ω–∏–∑–∞ —Ç–∞–π–º–µ—Ä–∞
                        );

                    } while (isOverlapping);

                    el.style.left = `${x}px`;
                    el.style.top = `${y}px`;
                    el.style.transform = `rotate(${Math.random() * 10 - 5}deg)`; // -5 to +5 deg

                    el.innerHTML = `
                        <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —é–∑–µ—Ä - —Å–æ–∑–¥–∞—Ç–µ–ª—å -->
                        ${sticker.createdBy === currentUserId ? `<button class="sticker-delete-btn" onclick="window.deleteSticker('${sticker.id}')" title="–£–¥–∞–ª–∏—Ç—å">&times;</button>` : ''}
                        <div class="sticker-text">${sticker.text}</div>
                        <span class="sticker-author">${sticker.nickname}</span>
                    `;
                    stickerBackdrop.appendChild(el);
                });
            }
            
            // –£–¥–∞–ª–µ–Ω–∏–µ
            window.deleteSticker = async (id) => {
                if (!currentUserId) return;
                
                const sticker = allStickers.find(s => s.id === id);
                if (sticker.createdBy !== currentUserId) {
                    console.warn("–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–∏—Ç—å —á—É–∂—É—é –ø–æ–º–µ—Ç–∫—É!");
                    return;
                }
                
                const stickerRef = doc(db, `/artifacts/${appId}/public/data/stickers`, id);
                try {
                    await deleteDoc(stickerRef);
                } catch (e) { console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–º–µ—Ç–∫–∏:", e); }
            };

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
            addStickerBtn.addEventListener('click', async () => {
                const text = newStickerText.value.trim();
                if (!text || !currentUserId || !currentUserNickname) return;
                
                addStickerBtn.disabled = true;
                const newSticker = {
                    text: text,
                    createdBy: currentUserId,
                    nickname: currentUserNickname,
                    createdAt: Timestamp.now()
                };
                
                try {
                    const stickersCol = collection(db, `/artifacts/${appId}/public/data/stickers`);
                    await addDoc(stickersCol, newSticker);
                    newStickerText.value = '';
                    stickerModal.style.display = 'none'; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                } catch (e) { console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–º–µ—Ç–∫–∏:", e); }
                finally { addStickerBtn.disabled = false; }
            });
            
            // –û—Ç–∫—Ä—ã—Ç–∏–µ/–ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤
            openStickerModalBtn.addEventListener('click', () => stickerModal.style.display = 'flex');
            closeStickerModalBtn.addEventListener('click', () => stickerModal.style.display = 'none');
            stickerModal.addEventListener('click', (e) => { if(e.target === stickerModal) stickerModal.style.display = 'none'; });
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–∏–∫–µ—Ä–æ–≤ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
            window.addEventListener('resize', renderStickers);

        });
    </script>
</body>
</html>